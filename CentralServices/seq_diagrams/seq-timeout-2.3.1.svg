<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1857px" preserveAspectRatio="none" style="width:1307px;height:1857px;" version="1.1" viewBox="0 0 1307 1857" width="1307px" zoomAndPan="magnify"><defs><filter height="300%" id="f3zv1coa7r7kz" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="259" x="525" y="22.9951">2.3.1. Timeout Handler Consume</text><rect fill="#FFFFE0" height="1811.8906" style="stroke: #A80036; stroke-width: 1.0;" width="1142" x="49" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="564.5" y="46.3638">Central Service</text><rect fill="#FFFFFF" filter="url(#f3zv1coa7r7kz)" height="1646.1641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="138.5" y="125.7266"/><rect fill="#FFFFFF" filter="url(#f3zv1coa7r7kz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="387" y="1711.8906"/><rect fill="#FFFFFF" filter="url(#f3zv1coa7r7kz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="615.5" y="1265.8984"/><rect fill="#FFFFFF" filter="url(#f3zv1coa7r7kz)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="859" y="330.9219"/><rect fill="#FFFFFF" filter="url(#f3zv1coa7r7kz)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1134" y="360.0547"/><rect fill="#FFFFFF" filter="url(#f3zv1coa7r7kz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1134" y="644.3828"/><rect fill="#FFFFFF" filter="url(#f3zv1coa7r7kz)" height="1631.1641" style="stroke: #000000; stroke-width: 2.0;" width="1283" x="13" y="132.7266"/><rect fill="#FFFFFF" filter="url(#f3zv1coa7r7kz)" height="91.5313" style="stroke: #000000; stroke-width: 2.0;" width="772" x="43" y="156.8594"/><rect fill="#FFFFFF" filter="url(#f3zv1coa7r7kz)" height="212.1953" style="stroke: #000000; stroke-width: 2.0;" width="1185" x="43" y="262.3906"/><rect fill="#FFFFFF" filter="url(#f3zv1coa7r7kz)" height="1268.3047" style="stroke: #000000; stroke-width: 2.0;" width="1263" x="23" y="488.5859"/><rect fill="#FFFFFF" filter="url(#f3zv1coa7r7kz)" height="1212.1719" style="stroke: #000000; stroke-width: 2.0;" width="1243" x="33" y="537.7188"/><rect fill="#FFFFFF" filter="url(#f3zv1coa7r7kz)" height="197.9297" style="stroke: #000000; stroke-width: 2.0;" width="1223" x="43" y="561.8516"/><rect fill="#FFFFFF" height="445.9922" style="stroke: none; stroke-width: 1.0;" width="1243" x="33" y="1303.8984"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="143" x2="143" y1="115.7266" y2="1780.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="392" x2="392" y1="115.7266" y2="1780.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="620" x2="620" y1="115.7266" y2="1780.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="753" x2="753" y1="115.7266" y2="1780.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="864" x2="864" y1="115.7266" y2="1780.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="971" x2="971" y1="115.7266" y2="1780.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1139" x2="1139" y1="115.7266" y2="1780.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="175" x="53" y="112.4248">Transfer Timeout Handler</text><ellipse cx="143.5" cy="83.4297" fill="#FEFECE" filter="url(#f3zv1coa7r7kz)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="139.5,71.4297,145.5,66.4297,143.5,71.4297,145.5,76.4297,139.5,71.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="175" x="53" y="1792.8857">Transfer Timeout Handler</text><ellipse cx="143.5" cy="1812.1875" fill="#FEFECE" filter="url(#f3zv1coa7r7kz)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="139.5,1800.1875,145.5,1795.1875,143.5,1800.1875,145.5,1805.1875,139.5,1800.1875" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f3zv1coa7r7kz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="288" x="248" y="76.4297"/><rect fill="#FEFECE" filter="url(#f3zv1coa7r7kz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="288" x="244" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="274" x="251" y="100.4248">Topic-{currency}-DFSPn-Position-Abort</text><rect fill="#FEFECE" filter="url(#f3zv1coa7r7kz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="288" x="248" y="1779.8906"/><rect fill="#FEFECE" filter="url(#f3zv1coa7r7kz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="288" x="244" y="1783.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="274" x="251" y="1803.8857">Topic-{currency}-DFSPn-Position-Abort</text><rect fill="#FEFECE" filter="url(#f3zv1coa7r7kz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="554" y="76.4297"/><rect fill="#FEFECE" filter="url(#f3zv1coa7r7kz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="550" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="557" y="100.4248">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f3zv1coa7r7kz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="554" y="1779.8906"/><rect fill="#FEFECE" filter="url(#f3zv1coa7r7kz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="550" y="1783.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="557" y="1803.8857">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f3zv1coa7r7kz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="705" y="76.4297"/><rect fill="#FEFECE" filter="url(#f3zv1coa7r7kz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="701" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="708" y="100.4248">Event-Topic</text><rect fill="#FEFECE" filter="url(#f3zv1coa7r7kz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="705" y="1779.8906"/><rect fill="#FEFECE" filter="url(#f3zv1coa7r7kz)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="701" y="1783.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="708" y="1803.8857">Event-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="815" y="112.4248">Transfer DAO</text><ellipse cx="864" cy="83.4297" fill="#FEFECE" filter="url(#f3zv1coa7r7kz)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="852" x2="876" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="815" y="1792.8857">Transfer DAO</text><ellipse cx="864" cy="1812.1875" fill="#FEFECE" filter="url(#f3zv1coa7r7kz)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="852" x2="876" y1="1826.1875" y2="1826.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="923" y="112.4248">Position DAO</text><ellipse cx="971" cy="83.4297" fill="#FEFECE" filter="url(#f3zv1coa7r7kz)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="959" x2="983" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="923" y="1792.8857">Position DAO</text><ellipse cx="971" cy="1812.1875" fill="#FEFECE" filter="url(#f3zv1coa7r7kz)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="959" x2="983" y1="1826.1875" y2="1826.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1091" y="112.4248">Central Store</text><path d="M1121,63.4297 C1121,53.4297 1139,53.4297 1139,53.4297 C1139,53.4297 1157,53.4297 1157,63.4297 L1157,89.4297 C1157,99.4297 1139,99.4297 1139,99.4297 C1139,99.4297 1121,99.4297 1121,89.4297 L1121,63.4297 " fill="#FEFECE" filter="url(#f3zv1coa7r7kz)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1121,63.4297 C1121,73.4297 1139,73.4297 1139,73.4297 C1139,73.4297 1157,73.4297 1157,63.4297 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1091" y="1792.8857">Central Store</text><path d="M1121,1806.1875 C1121,1796.1875 1139,1796.1875 1139,1796.1875 C1139,1796.1875 1157,1796.1875 1157,1806.1875 L1157,1832.1875 C1157,1842.1875 1139,1842.1875 1139,1842.1875 C1139,1842.1875 1121,1842.1875 1121,1832.1875 L1121,1806.1875 " fill="#FEFECE" filter="url(#f3zv1coa7r7kz)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1121,1806.1875 C1121,1816.1875 1139,1816.1875 1139,1816.1875 C1139,1816.1875 1157,1816.1875 1157,1806.1875 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f3zv1coa7r7kz)" height="1646.1641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="138.5" y="125.7266"/><rect fill="#FFFFFF" filter="url(#f3zv1coa7r7kz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="387" y="1711.8906"/><rect fill="#FFFFFF" filter="url(#f3zv1coa7r7kz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="615.5" y="1265.8984"/><rect fill="#FFFFFF" filter="url(#f3zv1coa7r7kz)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="859" y="330.9219"/><rect fill="#FFFFFF" filter="url(#f3zv1coa7r7kz)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1134" y="360.0547"/><rect fill="#FFFFFF" filter="url(#f3zv1coa7r7kz)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1134" y="644.3828"/><path d="M13,132.7266 L253,132.7266 L253,139.7266 L243,149.7266 L13,149.7266 L13,132.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1631.1641" style="stroke: #000000; stroke-width: 2.0;" width="1283" x="13" y="132.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="195" x="28" y="145.7935">Timeout Handler Consume</text><path d="M43,156.8594 L275,156.8594 L275,163.8594 L265,173.8594 L43,173.8594 L43,156.8594 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="91.5313" style="stroke: #000000; stroke-width: 2.0;" width="772" x="43" y="156.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="187" x="58" y="169.9263">Persist Event Information</text><polygon fill="#A80036" points="741,191.125,751,195.125,741,199.125,745,195.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="148.5" x2="747" y1="195.125" y2="195.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="155.5" y="190.0591">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="168.5" y="190.0591">Publish event information</text><rect fill="#FFFFFF" filter="url(#f3zv1coa7r7kz)" height="40.2656" style="stroke: #000000; stroke-width: 2.0;" width="754" x="50" y="203.125"/><polygon fill="#EEEEEE" points="50,203.125,116,203.125,116,210.125,106,220.125,50,220.125,50,203.125" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="63" y="217.1919">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="323.5" y="236.1919">Event Handler Consume {9.1.0.}</text><path d="M43,262.3906 L282,262.3906 L282,269.3906 L272,279.3906 L43,279.3906 L43,262.3906 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="212.1953" style="stroke: #000000; stroke-width: 2.0;" width="1185" x="43" y="262.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="194" x="58" y="275.4575">Request expired transfers</text><polygon fill="#A80036" points="847,326.9219,857,330.9219,847,334.9219,851,330.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="148.5" x2="853" y1="330.9219" y2="330.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="155.5" y="310.7231">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="379" x="168.5" y="295.5903">Request all expired transfers (Date.now() &gt; expirationDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="360" x="168.5" y="310.7231">with transferState IN ['RECEIVED_PREPARE', 'RESERVED']</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="168.5" y="325.856">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="262.5" y="325.856">2003, 3208</text><polygon fill="#A80036" points="1122,356.0547,1132,360.0547,1122,364.0547,1126,360.0547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="869" x2="1128" y1="360.0547" y2="360.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="876" y="354.9888">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="889" y="354.9888">Fetch from database</text><polygon fill="#A80036" points="880,385.1875,870,389.1875,880,393.1875,876,389.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="874" x2="1138" y1="389.1875" y2="389.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="886" y="384.1216">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="903" y="384.1216"/><polygon fill="#FFFFE0" filter="url(#f3zv1coa7r7kz)" points="1070,402.1875,1208,402.1875,1218,421.1875,1208,440.1875,1070,440.1875,1060,421.1875,1070,402.1875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1072" y="418.2544">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1072" y="433.3872">transferStateChange</text><polygon fill="#A80036" points="159.5,462.5859,149.5,466.5859,159.5,470.5859,155.5,466.5859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="153.5" x2="863" y1="466.5859" y2="466.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="165.5" y="461.52">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="178.5" y="461.52">Return list of all transfers to be aborted</text><path d="M23,488.5859 L100,488.5859 L100,495.5859 L90,505.5859 L23,505.5859 L23,488.5859 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1268.3047" style="stroke: #000000; stroke-width: 2.0;" width="1263" x="23" y="488.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="38" y="501.6528">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="183" x="115" y="500.7964">[for each transfer in the list]</text><path d="M33,537.7188 L97,537.7188 L97,544.7188 L87,554.7188 L33,554.7188 L33,537.7188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1212.1719" style="stroke: #000000; stroke-width: 2.0;" width="1243" x="33" y="537.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="48" y="550.7856">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="251" x="112" y="549.9292">[transferState == 'RECEIVED_PREPARE']</text><path d="M43,561.8516 L132,561.8516 L132,568.8516 L122,578.8516 L43,578.8516 L43,561.8516 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="197.9297" style="stroke: #000000; stroke-width: 2.0;" width="1223" x="43" y="561.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="44" x="58" y="574.9185">group</text><polygon fill="#A80036" points="959,611.25,969,615.25,959,619.25,963,615.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="148.5" x2="965" y1="615.25" y2="615.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="155.5" y="602.6177">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="168.5" y="595.0513">Request to persist latest state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="168.5" y="610.1841">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="254.5" y="610.1841">2003</text><polygon fill="#A80036" points="1122,640.3828,1132,644.3828,1122,648.3828,1126,644.3828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="971" x2="1128" y1="644.3828" y2="644.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="978" y="639.3169">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="131" x="991" y="639.3169">Persist state change</text><polygon fill="#FFFFE0" filter="url(#f3zv1coa7r7kz)" points="1032,687.3828,1246,687.3828,1256,706.3828,1246,725.3828,1032,725.3828,1022,706.3828,1032,687.3828" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="45" x="1034" y="703.4497">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="1083" y="703.4497">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="1034" y="718.5825">SET transferStateId = 'ABORTED'</text><polygon fill="#A80036" points="159.5,747.7813,149.5,751.7813,159.5,755.7813,155.5,751.7813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="153.5" x2="970" y1="751.7813" y2="751.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="165.5" y="746.7153">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="178.5" y="746.7153">Return success</text><path d="M153,771.7813 L153,1234.7813 L755,1234.7813 L755,781.7813 L745,771.7813 L153,771.7813 " fill="#FFFF00" filter="url(#f3zv1coa7r7kz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M745,771.7813 L745,781.7813 L755,781.7813 L745,771.7813 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="159" y="788.8481">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="159" y="803.981">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="175" y="819.1138">id: &lt;transferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="175" y="834.2466">from: &lt;payerParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="175" y="849.3794">to: &lt;payeeParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="175" y="864.5122">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="175" y="879.645"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="175" y="879.645">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="191" y="894.7778"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="191" y="894.7778">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="191" y="909.9106">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="211" y="925.0435">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="227" y="940.1763">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="513" x="227" y="955.3091">"errorDescription": "Client requested to use a transfer that has already expired.",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="227" y="970.4419">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="211" y="985.5747">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="191" y="1000.7075">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="175" y="1015.8403"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="175" y="1015.8403">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="175" y="1030.9731">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="191" y="1046.106">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="207" y="1061.2388">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="207" y="1076.3716">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="207" y="1091.5044">action: timeout-received,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="207" y="1106.6372">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="207" y="1121.77">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="223" y="1136.9028">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="223" y="1152.0356">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="223" y="1167.1685">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="207" y="1182.3013">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="191" y="1197.4341">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="175" y="1212.5669">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="159" y="1227.6997">}</text><polygon fill="#A80036" points="603.5,1261.8984,613.5,1265.8984,603.5,1269.8984,607.5,1265.8984" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="148.5" x2="609.5" y1="1265.8984" y2="1265.8984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="155.5" y="1260.8325">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="168.5" y="1260.8325">Publish to Notification event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="33" x2="1276" y1="1304.8984" y2="1304.8984"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="192" x="38" y="1315.1089">[transferState == 'RESERVED']</text><path d="M153,1323.7031 L153,1681.7031 L396,1681.7031 L396,1333.7031 L386,1323.7031 L153,1323.7031 " fill="#FFFF00" filter="url(#f3zv1coa7r7kz)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M386,1323.7031 L386,1333.7031 L396,1333.7031 L386,1323.7031 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="159" y="1340.77">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="159" y="1355.9028">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="175" y="1371.0356">id: &lt;transferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="175" y="1386.1685">from: &lt;payerParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="175" y="1401.3013">to: &lt;payeeParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="175" y="1416.4341">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="175" y="1431.5669"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="175" y="1431.5669">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="191" y="1446.6997"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="191" y="1446.6997">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="191" y="1461.8325"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="191" y="1461.8325">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="175" y="1476.9653"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="175" y="1476.9653">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="175" y="1492.0981">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="191" y="1507.231">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="207" y="1522.3638">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="207" y="1537.4966">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="207" y="1552.6294">action: timeout-reserved,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="207" y="1567.7622">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="207" y="1582.895">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="223" y="1598.0278">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="223" y="1613.1606">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="207" y="1628.2935">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="191" y="1643.4263">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="175" y="1658.5591">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="159" y="1673.6919">}</text><polygon fill="#A80036" points="375,1707.8906,385,1711.8906,375,1715.8906,379,1711.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="148.5" x2="381" y1="1711.8906" y2="1711.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="155.5" y="1706.8247">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="177.5" y="1706.8247">Route &amp; Publish Position event</text><!--
@startuml
title 2.3.1. Timeout Handler Consume

autonumber


control "Transfer Timeout Handler" as EXP_HANDLER
collections "Topic-{currency}-DFSPn-Position-Abort" as TOPIC_POSITION_DFSP
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
collections "Event-Topic" as TOPIC_EVENT
entity "Transfer DAO" as TRANS_DAO
entity "Position DAO" as POS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant EXP_HANDLER
    participant TOPIC_POSITION_DFSP
    participant TOPIC_NOTIFICATIONS
    participant TOPIC_EVENT
    participant TRANS_DAO
    participant POS_DAO
    participant DB
end box

activate EXP_HANDLER
group Timeout Handler Consume
    group Persist Event Information
        EXP_HANDLER -> TOPIC_EVENT: Publish event information
        ref over EXP_HANDLER, TOPIC_EVENT :  Event Handler Consume {9.1.0.}
    end

    group Request expired transfers
        EXP_HANDLER -> TRANS_DAO: Request all expired transfers (Date.now() > expirationDate) \nwith transferState IN ['RECEIVED_PREPARE', 'RESERVED']\n<color #FF0000><b>Error codes:</b> 2003, 3208</color>
        activate TRANS_DAO
        TRANS_DAO -> DB: Fetch from database
        activate DB
        DB - -> TRANS_DAO
        deactivate DB
        hnote over DB #lightyellow
            transfer
            transferStateChange
        end note
        EXP_HANDLER <- - TRANS_DAO: Return list of all transfers to be aborted
        deactivate TRANS_DAO
    end

    loop for each transfer in the list
        |||
        alt transferState == 'RECEIVED_PREPARE'
            group
                EXP_HANDLER -> POS_DAO: Request to persist latest state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
                POS_DAO -> DB: Persist state change
                hnote over DB #lightyellow
                        INSERT **transferStateChange**
                        SET transferStateId = 'ABORTED'
                end note
                activate DB
                deactivate DB
                POS_DAO - -> EXP_HANDLER: Return success
            end
            note right of EXP_HANDLER #yellow
                Message:
                {
                    id: <transferId>,
                    from: <payerParticipantId>,
                    to: <payeeParticipantId>,
                    type: application/json,
                    <color #FF0000>content: {</color>
                        <color #FF0000>headers: <transferHeaders>,</color>
                        payload: {
                             "errorInformation": {
                                 "errorCode": 3303,
                                 "errorDescription": "Client requested to use a transfer that has already expired.",
                                 "extensionList": <transferMessage.extensionList>
                             }
                        }
                    <color #FF0000>},</color>
                    metadata: {
                        event: {
                            id: <uuid>,
                            type: position,
                            action: timeout-received,
                            createdAt: <timestamp>,
                            state: {
                                status: 'error',
                                code: <errorInformation.errorCode>
                                description: <errorInformation.errorDescription>
                            }
                        }
                    }
                }
            end note
            EXP_HANDLER -> TOPIC_NOTIFICATIONS: Publish to Notification event
            activate TOPIC_NOTIFICATIONS
            deactivate TOPIC_NOTIFICATIONS
        else transferState == 'RESERVED'
            note right of EXP_HANDLER #yellow
                Message:
                {
                    id: <transferId>,
                    from: <payerParticipantId>,
                    to: <payeeParticipantId>,
                    type: application/json,
                    <color #FF0000>content: {</color>
                        <color #FF0000>headers: <transferHeaders>,</color>
                        <color #FF0000>payload: <transferMessage></color>
                    <color #FF0000>},</color>
                    metadata: {
                        event: {
                            id: <uuid>,
                            type: position,
                            action: timeout-reserved,
                            createdAt: <timestamp>,
                            state: {
                                status: "success",
                                code: 0
                            }
                        }
                    }
                }
            end note
            EXP_HANDLER -> TOPIC_POSITION_DFSP: Route & Publish Position event
            activate TOPIC_POSITION_DFSP
            deactivate TOPIC_POSITION_DFSP
        end

    end
end
@enduml

PlantUML version 1.2018.10beta2(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.7.0_25-b15
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>