<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3393px" preserveAspectRatio="none" style="width:2047px;height:3393px;" version="1.1" viewBox="0 0 2047 3393" width="2047px" zoomAndPan="magnify"><defs><filter height="300%" id="fydmojfywr5sg" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="315" x="867" y="22.9951">2.1.1. Fulfil Handler Consume (Success)</text><rect fill="#FFFFE0" height="3347.8906" style="stroke: #A80036; stroke-width: 1.0;" width="1873.5" x="29" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="910.25" y="46.3638">Central Service</text><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="75.5" y="195.125"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="3181.1641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="396.5" y="125.7266"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1018.5" y="3081.8828"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1300" y="3179.9531"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="150.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1429.5" y="677.25"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1429.5" y="967.7109"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1429.5" y="1536.5156"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1429.5" y="1740.3125"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="150.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1429.5" y="2067.9063"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="136.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1429.5" y="2301.1016"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="770.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1429.5" y="2537.1641"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="92.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1845.5" y="706.3828"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1845.5" y="996.8438"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1845.5" y="1565.6484"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1845.5" y="1769.4453"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1845.5" y="2097.0391"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1845.5" y="2330.2344"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1845.5" y="2566.2969"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="3167.1641" style="stroke: #000000; stroke-width: 2.0;" width="2023" x="13" y="132.7266"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="3136.0313" style="stroke: #000000; stroke-width: 2.0;" width="2003" x="23" y="156.8594"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="105.5313" style="stroke: #000000; stroke-width: 2.0;" width="518" x="313.5" y="240.125"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="74.3984" style="stroke: #000000; stroke-width: 2.0;" width="498" x="323.5" y="264.2578"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="91.5313" style="stroke: #000000; stroke-width: 2.0;" width="911" x="323.5" y="359.6563"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="102.5313" style="stroke: #000000; stroke-width: 2.0;" width="1062" x="323.5" y="465.1875"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="1091.1953" style="stroke: #000000; stroke-width: 2.0;" width="1722.5" x="293.5" y="581.7188"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="780.7344" style="stroke: #000000; stroke-width: 2.0;" width="1674.5" x="303.5" y="885.1797"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="360.0703" style="stroke: #000000; stroke-width: 2.0;" width="1082" x="313.5" y="1118.375"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="270" x="323.5" y="1142.5078"/><rect fill="#FFFFFF" height="106.3359" style="stroke: none; stroke-width: 1.0;" width="1082" x="313.5" y="1208.7734"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="77.5313" style="stroke: #000000; stroke-width: 2.0;" width="1062" x="323.5" y="1230.5781"/><rect fill="#FFFFFF" height="88.0703" style="stroke: none; stroke-width: 1.0;" width="1082" x="313.5" y="1315.1094"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="242" x="323.5" y="1336.9141"/><rect fill="#FFFFFF" height="75.2656" style="stroke: none; stroke-width: 1.0;" width="1082" x="313.5" y="1403.1797"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="348" x="323.5" y="1412.1797"/><rect fill="#FFFFFF" height="180.4688" style="stroke: none; stroke-width: 1.0;" width="1674.5" x="303.5" y="1485.4453"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="1545.0391" style="stroke: #000000; stroke-width: 2.0;" width="1655.5" x="303.5" y="1686.9141"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="243.3281" style="stroke: #000000; stroke-width: 2.0;" width="1627.5" x="313.5" y="1990.375"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="212.1953" style="stroke: #000000; stroke-width: 2.0;" width="1607.5" x="323.5" y="2014.5078"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="197.9297" style="stroke: #000000; stroke-width: 2.0;" width="1604.5" x="323.5" y="2247.7031"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="765.3203" style="stroke: #000000; stroke-width: 2.0;" width="1635.5" x="313.5" y="2459.6328"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="182.7969" style="stroke: #000000; stroke-width: 2.0;" width="1615.5" x="323.5" y="2483.7656"/><rect fill="#FFFFFF" height="105.0703" style="stroke: none; stroke-width: 1.0;" width="1635.5" x="313.5" y="3119.8828"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="76.2656" style="stroke: #000000; stroke-width: 2.0;" width="1062" x="323.5" y="3141.6875"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="2003" x="23" y="3238.9531"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="80" x2="80" y1="115.7266" y2="3316.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="401.5" x2="401.5" y1="115.7266" y2="3316.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1023.5" x2="1023.5" y1="115.7266" y2="3316.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1172.5" x2="1172.5" y1="115.7266" y2="3316.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1304.5" x2="1304.5" y1="115.7266" y2="3316.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1434.5" x2="1434.5" y1="115.7266" y2="3316.8906"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1850.5" x2="1850.5" y1="115.7266" y2="3316.8906"/><rect fill="#FEFECE" filter="url(#fydmojfywr5sg)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="37" y="76.4297"/><rect fill="#FEFECE" filter="url(#fydmojfywr5sg)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="33" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="40" y="100.4248">Fulfil-Topic</text><rect fill="#FEFECE" filter="url(#fydmojfywr5sg)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="37" y="3315.8906"/><rect fill="#FEFECE" filter="url(#fydmojfywr5sg)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="33" y="3319.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="40" y="3339.8857">Fulfil-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="130" x="333.5" y="112.4248">Fulfil Event Handler</text><ellipse cx="401.5" cy="83.4297" fill="#FEFECE" filter="url(#fydmojfywr5sg)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="397.5,71.4297,403.5,66.4297,401.5,71.4297,403.5,76.4297,397.5,71.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="130" x="333.5" y="3328.8857">Fulfil Event Handler</text><ellipse cx="401.5" cy="3348.1875" fill="#FEFECE" filter="url(#fydmojfywr5sg)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="397.5,3336.1875,403.5,3331.1875,401.5,3336.1875,403.5,3341.1875,397.5,3336.1875" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fydmojfywr5sg)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="940.5" y="76.4297"/><rect fill="#FEFECE" filter="url(#fydmojfywr5sg)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="936.5" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="943.5" y="100.4248">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#fydmojfywr5sg)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="940.5" y="3315.8906"/><rect fill="#FEFECE" filter="url(#fydmojfywr5sg)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="936.5" y="3319.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="943.5" y="3339.8857">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#fydmojfywr5sg)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="1124.5" y="76.4297"/><rect fill="#FEFECE" filter="url(#fydmojfywr5sg)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="1120.5" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1127.5" y="100.4248">Event-Topic</text><rect fill="#FEFECE" filter="url(#fydmojfywr5sg)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="1124.5" y="3315.8906"/><rect fill="#FEFECE" filter="url(#fydmojfywr5sg)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="1120.5" y="3319.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1127.5" y="3339.8857">Event-Topic</text><rect fill="#FEFECE" filter="url(#fydmojfywr5sg)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="1238.5" y="76.4297"/><rect fill="#FEFECE" filter="url(#fydmojfywr5sg)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="1234.5" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="1241.5" y="100.4248">Notification-Topic</text><rect fill="#FEFECE" filter="url(#fydmojfywr5sg)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="1238.5" y="3315.8906"/><rect fill="#FEFECE" filter="url(#fydmojfywr5sg)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="1234.5" y="3319.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="1241.5" y="3339.8857">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="1385.5" y="112.4248">Transfer DAO</text><ellipse cx="1434.5" cy="83.4297" fill="#FEFECE" filter="url(#fydmojfywr5sg)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1422.5" x2="1446.5" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="1385.5" y="3328.8857">Transfer DAO</text><ellipse cx="1434.5" cy="3348.1875" fill="#FEFECE" filter="url(#fydmojfywr5sg)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1422.5" x2="1446.5" y1="3362.1875" y2="3362.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1802.5" y="112.4248">Central Store</text><path d="M1832.5,63.4297 C1832.5,53.4297 1850.5,53.4297 1850.5,53.4297 C1850.5,53.4297 1868.5,53.4297 1868.5,63.4297 L1868.5,89.4297 C1868.5,99.4297 1850.5,99.4297 1850.5,99.4297 C1850.5,99.4297 1832.5,99.4297 1832.5,89.4297 L1832.5,63.4297 " fill="#FEFECE" filter="url(#fydmojfywr5sg)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1832.5,63.4297 C1832.5,73.4297 1850.5,73.4297 1850.5,73.4297 C1850.5,73.4297 1868.5,73.4297 1868.5,63.4297 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1802.5" y="3328.8857">Central Store</text><path d="M1832.5,3342.1875 C1832.5,3332.1875 1850.5,3332.1875 1850.5,3332.1875 C1850.5,3332.1875 1868.5,3332.1875 1868.5,3342.1875 L1868.5,3368.1875 C1868.5,3378.1875 1850.5,3378.1875 1850.5,3378.1875 C1850.5,3378.1875 1832.5,3378.1875 1832.5,3368.1875 L1832.5,3342.1875 " fill="#FEFECE" filter="url(#fydmojfywr5sg)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1832.5,3342.1875 C1832.5,3352.1875 1850.5,3352.1875 1850.5,3352.1875 C1850.5,3352.1875 1868.5,3352.1875 1868.5,3342.1875 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="75.5" y="195.125"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="3181.1641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="396.5" y="125.7266"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1018.5" y="3081.8828"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1300" y="3179.9531"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="150.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1429.5" y="677.25"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1429.5" y="967.7109"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1429.5" y="1536.5156"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1429.5" y="1740.3125"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="150.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1429.5" y="2067.9063"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="136.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1429.5" y="2301.1016"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="770.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1429.5" y="2537.1641"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="92.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1845.5" y="706.3828"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1845.5" y="996.8438"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1845.5" y="1565.6484"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1845.5" y="1769.4453"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1845.5" y="2097.0391"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1845.5" y="2330.2344"/><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1845.5" y="2566.2969"/><path d="M13,132.7266 L306,132.7266 L306,139.7266 L296,149.7266 L13,149.7266 L13,132.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3167.1641" style="stroke: #000000; stroke-width: 2.0;" width="2023" x="13" y="132.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="248" x="28" y="145.7935">Fulfil Handler Consume (Success)</text><path d="M23,156.8594 L87,156.8594 L87,163.8594 L77,173.8594 L23,173.8594 L23,156.8594 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3136.0313" style="stroke: #000000; stroke-width: 2.0;" width="2003" x="23" y="156.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="38" y="169.9263">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="174" x="102" y="169.0698">[Consume Single Message]</text><polygon fill="#A80036" points="96.5,191.125,86.5,195.125,96.5,199.125,92.5,195.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="90.5" x2="395.5" y1="195.125" y2="195.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="102.5" y="190.0591">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="279" x="115.5" y="190.0591">Consume Prepare event message for Payer</text><path d="M313.5,240.125 L401.5,240.125 L401.5,247.125 L391.5,257.125 L313.5,257.125 L313.5,240.125 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="105.5313" style="stroke: #000000; stroke-width: 2.0;" width="518" x="313.5" y="240.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="328.5" y="253.1919">break</text><path d="M323.5,264.2578 L475.5,264.2578 L475.5,271.2578 L465.5,281.2578 L323.5,281.2578 L323.5,264.2578 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.3984" style="stroke: #000000; stroke-width: 2.0;" width="498" x="323.5" y="264.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="107" x="338.5" y="277.3247">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="406.5" x2="448.5" y1="317.6563" y2="317.6563"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="448.5" x2="448.5" y1="317.6563" y2="330.6563"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="407.5" x2="448.5" y1="330.6563" y2="330.6563"/><polygon fill="#A80036" points="417.5,326.6563,407.5,330.6563,417.5,334.6563,413.5,330.6563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="413.5" y="305.0239">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="383" x="426.5" y="297.4575">Validate event - Rule: type == 'fulfil' &amp;&amp; action == 'commit'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="426.5" y="312.5903">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="520.5" y="312.5903">2001</text><path d="M323.5,359.6563 L555.5,359.6563 L555.5,366.6563 L545.5,376.6563 L323.5,376.6563 L323.5,359.6563 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="91.5313" style="stroke: #000000; stroke-width: 2.0;" width="911" x="323.5" y="359.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="187" x="338.5" y="372.7231">Persist Event Information</text><polygon fill="#A80036" points="1160.5,393.9219,1170.5,397.9219,1160.5,401.9219,1164.5,397.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="406.5" x2="1166.5" y1="397.9219" y2="397.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="413.5" y="392.856">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="426.5" y="392.856">Publish event information</text><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="40.2656" style="stroke: #000000; stroke-width: 2.0;" width="893" x="330.5" y="405.9219"/><polygon fill="#EEEEEE" points="330.5,405.9219,396.5,405.9219,396.5,412.9219,386.5,422.9219,330.5,422.9219,330.5,405.9219" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="343.5" y="419.9888">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="673.5" y="438.9888">Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="36" x="840.5" y="438.9888">9.1.0.</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="840.5" x2="876.5" y1="440.9888" y2="440.9888"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="876.5" y="438.9888">}</text><path d="M323.5,465.1875 L563.5,465.1875 L563.5,472.1875 L553.5,482.1875 L323.5,482.1875 L323.5,465.1875 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="102.5313" style="stroke: #000000; stroke-width: 2.0;" width="1062" x="323.5" y="465.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="195" x="338.5" y="478.2544">Validate FSPIOP-Signature</text><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="55.3984" style="stroke: #000000; stroke-width: 2.0;" width="1044" x="330.5" y="507.3203"/><polygon fill="#EEEEEE" points="330.5,507.3203,396.5,507.3203,396.5,514.3203,386.5,524.3203,330.5,524.3203,330.5,507.3203" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="343.5" y="521.3872">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="587" y="540.3872">Validate message.content.headers.</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="129" x="815" y="540.3872">FSPIOP-Signature</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="948" y="540.3872">{</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-signature-validation.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-signature-validation.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="154" x="956" y="540.3872">seq-signature-validation</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="956" x2="1110" y1="542.3872" y2="542.3872"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="1110" y="540.3872">}</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="587" y="555.52">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="681" y="555.52">3105/3106</text><path d="M293.5,581.7188 L669.5,581.7188 L669.5,588.7188 L659.5,598.7188 L293.5,598.7188 L293.5,581.7188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1091.1953" style="stroke: #000000; stroke-width: 2.0;" width="1722.5" x="293.5" y="581.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="331" x="308.5" y="594.7856">Validate Transfer Fulfilment Duplicate Check</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="406.5" x2="448.5" y1="619.9844" y2="619.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="448.5" x2="448.5" y1="619.9844" y2="632.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="407.5" x2="448.5" y1="632.9844" y2="632.9844"/><polygon fill="#A80036" points="417.5,628.9844,407.5,632.9844,417.5,636.9844,413.5,632.9844" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="413.5" y="614.9185">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="426.5" y="614.9185">Generate transferFulfilmentId uuid</text><polygon fill="#A80036" points="1417.5,673.25,1427.5,677.25,1417.5,681.25,1421.5,677.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="406.5" x2="1423.5" y1="677.25" y2="677.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="413.5" y="664.6177">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="373" x="426.5" y="657.0513">Request to retrieve transfer fulfilment hashes by transferId</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="426.5" y="672.1841">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="512.5" y="672.1841">2003</text><polygon fill="#A80036" points="1833.5,702.3828,1843.5,706.3828,1833.5,710.3828,1837.5,706.3828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1439.5" x2="1839.5" y1="706.3828" y2="706.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1446.5" y="701.3169">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="346" x="1459.5" y="701.3169">Request Transfer fulfilment duplicate message hashes</text><polygon fill="#FFFFE0" filter="url(#fydmojfywr5sg)" points="1704,719.3828,1996,719.3828,2006,745.3828,1996,772.3828,1704,772.3828,1694,745.3828,1704,719.3828" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="1706" y="735.4497">SELET transferId, hash</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1706" y="750.5825">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="248" x="1746" y="750.5825">transferFulfilmentDuplicateCheck</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="1706" y="765.7153">WHERE transferId = request.params.id</text><polygon fill="#A80036" points="1450.5,794.9141,1440.5,798.9141,1450.5,802.9141,1446.5,798.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1444.5" x2="1849.5" y1="798.9141" y2="798.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1456.5" y="793.8481">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="1469.5" y="793.8481">Return existing hashes</text><polygon fill="#A80036" points="417.5,824.0469,407.5,828.0469,417.5,832.0469,413.5,828.0469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="411.5" x2="1433.5" y1="828.0469" y2="828.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="423.5" y="822.981">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="303" x="436.5" y="822.981">Return (list of) transfer fulfil messages hash(es)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="406.5" x2="448.5" y1="857.1797" y2="857.1797"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="448.5" x2="448.5" y1="857.1797" y2="870.1797"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="407.5" x2="448.5" y1="870.1797" y2="870.1797"/><polygon fill="#A80036" points="417.5,866.1797,407.5,870.1797,417.5,874.1797,413.5,870.1797" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="413.5" y="852.1138">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="585" x="426.5" y="852.1138">Loop the list of returned hashes and compare each entry with the calculated message hash</text><path d="M303.5,885.1797 L367.5,885.1797 L367.5,892.1797 L357.5,902.1797 L303.5,902.1797 L303.5,885.1797 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="780.7344" style="stroke: #000000; stroke-width: 2.0;" width="1674.5" x="303.5" y="885.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="318.5" y="898.2466">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="382.5" y="897.3901">[Hash matched]</text><polygon fill="#A80036" points="1160.5,919.4453,1170.5,923.4453,1160.5,927.4453,1164.5,923.4453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="406.5" x2="1166.5" y1="923.4453" y2="923.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413.5" y="918.3794">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="435" x="435.5" y="918.3794">Publish event information (for duplicate) ( Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="32" x="870.5" y="918.3794">9.1.0</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="870.5" x2="902.5" y1="920.3794" y2="920.3794"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="902.5" y="918.3794">} )</text><polygon fill="#A80036" points="1417.5,963.7109,1427.5,967.7109,1417.5,971.7109,1421.5,967.7109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="406.5" x2="1423.5" y1="967.7109" y2="967.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413.5" y="955.0786">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="365" x="435.5" y="947.5122">Request to retrieve Transfer Fulfilment and Transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="435.5" y="962.645">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="521.5" y="962.645">2003</text><polygon fill="#A80036" points="1833.5,992.8438,1843.5,996.8438,1833.5,1000.8438,1837.5,996.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1439.5" x2="1839.5" y1="996.8438" y2="996.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1446.5" y="991.7778">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="365" x="1468.5" y="991.7778">Request to retrieve Transfer Fulfilment and Transfer state</text><polygon fill="#FFFFE0" filter="url(#fydmojfywr5sg)" points="1781,1009.8438,1919,1009.8438,1929,1028.8438,1919,1047.8438,1781,1047.8438,1771,1028.8438,1781,1009.8438" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="1783" y="1025.9106">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1783" y="1041.0435">transferStateChange</text><polygon fill="#A80036" points="1450.5,1070.2422,1440.5,1074.2422,1450.5,1078.2422,1446.5,1074.2422" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1444.5" x2="1849.5" y1="1074.2422" y2="1074.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1456.5" y="1069.1763">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="1478.5" y="1069.1763">Return Transfer Fulfilment and Transfer state</text><polygon fill="#A80036" points="417.5,1099.375,407.5,1103.375,417.5,1107.375,413.5,1103.375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="411.5" x2="1433.5" y1="1103.375" y2="1103.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="423.5" y="1098.3091">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="445.5" y="1098.3091">Return Transfer Fulfilment and Transfer state</text><path d="M313.5,1118.375 L377.5,1118.375 L377.5,1125.375 L367.5,1135.375 L313.5,1135.375 L313.5,1118.375 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="360.0703" style="stroke: #000000; stroke-width: 2.0;" width="1082" x="313.5" y="1118.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="328.5" y="1131.4419">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="392.5" y="1130.5854">[transferFulfilment.isValid == 0]</text><path d="M323.5,1142.5078 L411.5,1142.5078 L411.5,1149.5078 L401.5,1159.5078 L323.5,1159.5078 L323.5,1142.5078 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="270" x="323.5" y="1142.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="338.5" y="1155.5747">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="406.5" x2="448.5" y1="1180.7734" y2="1180.7734"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="448.5" x2="448.5" y1="1180.7734" y2="1193.7734"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="407.5" x2="448.5" y1="1193.7734" y2="1193.7734"/><polygon fill="#A80036" points="417.5,1189.7734,407.5,1193.7734,417.5,1197.7734,413.5,1193.7734" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413.5" y="1175.7075">15</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="110" x="435.5" y="1175.7075">Error handling:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="549.5" y="1175.7075">3106</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="313.5" x2="1395.5" y1="1209.7734" y2="1209.7734"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="284" x="318.5" y="1219.9839">[transferState IN ['COMMITTED', 'ABORTED']]</text><path d="M323.5,1230.5781 L411.5,1230.5781 L411.5,1237.5781 L401.5,1247.5781 L323.5,1247.5781 L323.5,1230.5781 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="77.5313" style="stroke: #000000; stroke-width: 2.0;" width="1062" x="323.5" y="1230.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="338.5" y="1243.645">break</text><rect fill="#FFFFFF" filter="url(#fydmojfywr5sg)" height="55.3984" style="stroke: #000000; stroke-width: 2.0;" width="1044" x="330.5" y="1247.7109"/><polygon fill="#EEEEEE" points="330.5,1247.7109,396.5,1247.7109,396.5,1254.7109,386.5,1264.7109,330.5,1264.7109,330.5,1247.7109" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="343.5" y="1261.7778">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="694" y="1280.7778">Send notification to Participant (Payee) {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-prepare-1.1.4.a.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-prepare-1.1.4.a.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="48" x="955" y="1280.7778">1.1.4.a.</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="955" x2="1003" y1="1282.7778" y2="1282.7778"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="1003" y="1280.7778">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="698" y="1295.9106"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="313.5" x2="1395.5" y1="1316.1094" y2="1316.1094"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="201" x="318.5" y="1326.3198">[transferState NOT 'RESERVED']</text><path d="M323.5,1336.9141 L411.5,1336.9141 L411.5,1343.9141 L401.5,1353.9141 L323.5,1353.9141 L323.5,1336.9141 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="242" x="323.5" y="1336.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="338.5" y="1349.981">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="406.5" x2="448.5" y1="1375.1797" y2="1375.1797"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="448.5" x2="448.5" y1="1375.1797" y2="1388.1797"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="407.5" x2="448.5" y1="1388.1797" y2="1388.1797"/><polygon fill="#A80036" points="417.5,1384.1797,407.5,1388.1797,417.5,1392.1797,413.5,1388.1797" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413.5" y="1370.1138">16</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="435.5" y="1370.1138">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="521.5" y="1370.1138">2001</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="313.5" x2="1395.5" y1="1404.1797" y2="1404.1797"/><path d="M323.5,1412.1797 L411.5,1412.1797 L411.5,1419.1797 L401.5,1429.1797 L323.5,1429.1797 L323.5,1412.1797 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="348" x="323.5" y="1412.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="338.5" y="1425.2466">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="406.5" x2="448.5" y1="1450.4453" y2="1450.4453"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="448.5" x2="448.5" y1="1450.4453" y2="1463.4453"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="407.5" x2="448.5" y1="1463.4453" y2="1463.4453"/><polygon fill="#A80036" points="417.5,1459.4453,407.5,1463.4453,417.5,1467.4453,413.5,1463.4453" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413.5" y="1445.3794">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="435.5" y="1445.3794">Allow previous request to complete</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="303.5" x2="1978" y1="1486.4453" y2="1486.4453"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="308.5" y="1496.6558">[Hash not matched]</text><polygon fill="#A80036" points="1417.5,1532.5156,1427.5,1536.5156,1417.5,1540.5156,1421.5,1536.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="406.5" x2="1423.5" y1="1536.5156" y2="1536.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413.5" y="1523.8833">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="435.5" y="1516.3169">Request to persist transfer hash</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="435.5" y="1531.4497">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="529.5" y="1531.4497">2003</text><polygon fill="#A80036" points="1833.5,1561.6484,1843.5,1565.6484,1833.5,1569.6484,1837.5,1565.6484" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1439.5" x2="1839.5" y1="1565.6484" y2="1565.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1446.5" y="1560.5825">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="1468.5" y="1560.5825">Persist hash</text><polygon fill="#FFFFE0" filter="url(#fydmojfywr5sg)" points="1743,1608.6484,1958,1608.6484,1968,1619.6484,1958,1631.6484,1743,1631.6484,1733,1619.6484,1743,1608.6484" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="1745" y="1624.7153">transferFulfilmentDuplicateCheck</text><polygon fill="#A80036" points="417.5,1653.9141,407.5,1657.9141,417.5,1661.9141,413.5,1657.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="411.5" x2="1433.5" y1="1657.9141" y2="1657.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="423.5" y="1652.8481">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="445.5" y="1652.8481">Return success</text><path d="M303.5,1686.9141 L643.5,1686.9141 L643.5,1693.9141 L633.5,1703.9141 L303.5,1703.9141 L303.5,1686.9141 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1545.0391" style="stroke: #000000; stroke-width: 2.0;" width="1655.5" x="303.5" y="1686.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="295" x="318.5" y="1699.981">Validate and persist Transfer Fulfilment</text><polygon fill="#A80036" points="1417.5,1736.3125,1427.5,1740.3125,1417.5,1744.3125,1421.5,1740.3125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="406.5" x2="1423.5" y1="1740.3125" y2="1740.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413.5" y="1727.6802">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="435.5" y="1720.1138">Request information for the validate checks</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="435.5" y="1735.2466">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="521.5" y="1735.2466">2003</text><polygon fill="#A80036" points="1833.5,1765.4453,1843.5,1769.4453,1833.5,1773.4453,1837.5,1769.4453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1439.5" x2="1839.5" y1="1769.4453" y2="1769.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1446.5" y="1764.3794">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="1468.5" y="1764.3794">Fetch from database</text><polygon fill="#FFFFE0" filter="url(#fydmojfywr5sg)" points="1823,1782.4453,1877,1782.4453,1887,1793.4453,1877,1805.4453,1823,1805.4453,1813,1793.4453,1823,1782.4453" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1825" y="1798.5122">transfer</text><polygon fill="#A80036" points="1450.5,1827.7109,1440.5,1831.7109,1450.5,1835.7109,1446.5,1831.7109" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1444.5" x2="1849.5" y1="1831.7109" y2="1831.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1456.5" y="1826.645">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1482.5" y="1826.645"/><polygon fill="#A80036" points="417.5,1856.8438,407.5,1860.8438,417.5,1864.8438,413.5,1860.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="411.5" x2="1433.5" y1="1860.8438" y2="1860.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="423.5" y="1855.7778">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="445.5" y="1855.7778">Return transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="406.5" x2="448.5" y1="1905.1094" y2="1905.1094"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="448.5" x2="448.5" y1="1905.1094" y2="1918.1094"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="407.5" x2="448.5" y1="1918.1094" y2="1918.1094"/><polygon fill="#A80036" points="417.5,1914.1094,407.5,1918.1094,417.5,1922.1094,413.5,1918.1094" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413.5" y="1892.4771">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="472" x="435.5" y="1884.9106">Validate that Transfer.ilpCondition = SHA-256 (content.payload.fulfilment)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="435.5" y="1900.0435">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="521.5" y="1900.0435">2001</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="406.5" x2="448.5" y1="1962.375" y2="1962.375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="448.5" x2="448.5" y1="1962.375" y2="1975.375"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="407.5" x2="448.5" y1="1975.375" y2="1975.375"/><polygon fill="#A80036" points="417.5,1971.375,407.5,1975.375,417.5,1979.375,413.5,1975.375" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413.5" y="1949.7427">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="435.5" y="1942.1763">Validate expirationDate</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="435.5" y="1957.3091">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="521.5" y="1957.3091">3303</text><path d="M313.5,1990.375 L383.5,1990.375 L383.5,1997.375 L373.5,2007.375 L313.5,2007.375 L313.5,1990.375 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="243.3281" style="stroke: #000000; stroke-width: 2.0;" width="1627.5" x="313.5" y="1990.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="25" x="328.5" y="2003.4419">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="274" x="398.5" y="2002.5854">[Transfer.ilpCondition validate successful]</text><path d="M323.5,2014.5078 L636.5,2014.5078 L636.5,2021.5078 L626.5,2031.5078 L323.5,2031.5078 L323.5,2014.5078 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="212.1953" style="stroke: #000000; stroke-width: 2.0;" width="1607.5" x="323.5" y="2014.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="268" x="338.5" y="2027.5747">Request current Settlement Window</text><polygon fill="#A80036" points="1417.5,2063.9063,1427.5,2067.9063,1417.5,2071.9063,1421.5,2067.9063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="406.5" x2="1423.5" y1="2067.9063" y2="2067.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413.5" y="2055.2739">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="435.5" y="2047.7075">Request to retrieve current/latest transfer settlement window</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="435.5" y="2062.8403">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="521.5" y="2062.8403">2003</text><polygon fill="#A80036" points="1833.5,2093.0391,1843.5,2097.0391,1833.5,2101.0391,1837.5,2097.0391" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1439.5" x2="1839.5" y1="2097.0391" y2="2097.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1446.5" y="2091.9731">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="1468.5" y="2091.9731">Fetch settlementWindowId</text><polygon fill="#A80036" points="1450.5,2122.1719,1440.5,2126.1719,1450.5,2130.1719,1446.5,2126.1719" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1444.5" x2="1849.5" y1="2126.1719" y2="2126.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1456.5" y="2121.106">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1482.5" y="2121.106"/><polygon fill="#FFFFE0" filter="url(#fydmojfywr5sg)" points="1790,2139.1719,1911,2139.1719,1921,2150.1719,1911,2162.1719,1790,2162.1719,1780,2150.1719,1790,2139.1719" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="1792" y="2155.2388">settlementWindow</text><polygon fill="#A80036" points="417.5,2214.7031,407.5,2218.7031,417.5,2222.7031,413.5,2218.7031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="411.5" x2="1433.5" y1="2218.7031" y2="2218.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="423.5" y="2198.5044">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="479" x="445.5" y="2183.3716">Return settlementWindowId to be appended during transferFulfilment insert</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="41" x="445.5" y="2198.5044">TODO</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="437" x="486.5" y="2198.5044">: During settlement design make sure transfers in 'RECEIVED-FULFIL'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="445.5" y="2213.6372">state are updated to the next settlement window</text><path d="M323.5,2247.7031 L495.5,2247.7031 L495.5,2254.7031 L485.5,2264.7031 L323.5,2264.7031 L323.5,2247.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="197.9297" style="stroke: #000000; stroke-width: 2.0;" width="1604.5" x="323.5" y="2247.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="338.5" y="2260.77">Persist fulfilment</text><polygon fill="#A80036" points="1417.5,2297.1016,1427.5,2301.1016,1417.5,2305.1016,1421.5,2301.1016" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="406.5" x2="1423.5" y1="2301.1016" y2="2301.1016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413.5" y="2288.4692">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="496" x="435.5" y="2280.9028">Persist fulfilment with the result of the above check (transferFulfilment.isValid)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="435.5" y="2296.0356">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="521.5" y="2296.0356">2003</text><polygon fill="#A80036" points="1833.5,2326.2344,1843.5,2330.2344,1833.5,2334.2344,1837.5,2330.2344" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1439.5" x2="1839.5" y1="2330.2344" y2="2330.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1446.5" y="2325.1685">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="1468.5" y="2325.1685">Persist to database</text><polygon fill="#FFFFE0" filter="url(#fydmojfywr5sg)" points="1792,2373.2344,1908,2373.2344,1918,2392.2344,1908,2411.2344,1792,2411.2344,1782,2392.2344,1792,2373.2344" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="1794" y="2389.3013">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="1794" y="2404.4341">transferExtension</text><polygon fill="#A80036" points="417.5,2433.6328,407.5,2437.6328,417.5,2441.6328,413.5,2437.6328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="411.5" x2="1433.5" y1="2437.6328" y2="2437.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="423.5" y="2432.5669">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="445.5" y="2432.5669">Return success</text><path d="M313.5,2459.6328 L377.5,2459.6328 L377.5,2466.6328 L367.5,2476.6328 L313.5,2476.6328 L313.5,2459.6328 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="765.3203" style="stroke: #000000; stroke-width: 2.0;" width="1635.5" x="313.5" y="2459.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="328.5" y="2472.6997">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="274" x="392.5" y="2471.8433">[Transfer.ilpCondition validate successful]</text><path d="M323.5,2483.7656 L824.5,2483.7656 L824.5,2490.7656 L814.5,2500.7656 L323.5,2500.7656 L323.5,2483.7656 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="182.7969" style="stroke: #000000; stroke-width: 2.0;" width="1615.5" x="323.5" y="2483.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="456" x="338.5" y="2496.8325">Persist Transfer State (with transferState='RECEIVED-FULFIL')</text><polygon fill="#A80036" points="1417.5,2533.1641,1427.5,2537.1641,1417.5,2541.1641,1421.5,2537.1641" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="406.5" x2="1423.5" y1="2537.1641" y2="2537.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413.5" y="2524.5317">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="435.5" y="2516.9653">Request to persist transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82" x="435.5" y="2532.0981">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="521.5" y="2532.0981">2003</text><polygon fill="#A80036" points="1833.5,2562.2969,1843.5,2566.2969,1833.5,2570.2969,1837.5,2566.2969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1439.5" x2="1839.5" y1="2566.2969" y2="2566.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1446.5" y="2561.231">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1468.5" y="2561.231">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#fydmojfywr5sg)" points="1781,2609.2969,1919,2609.2969,1929,2620.2969,1919,2632.2969,1781,2632.2969,1771,2620.2969,1781,2609.2969" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1783" y="2625.3638">transferStateChange</text><polygon fill="#A80036" points="417.5,2654.5625,407.5,2658.5625,417.5,2662.5625,413.5,2658.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="411.5" x2="1428.5" y1="2658.5625" y2="2658.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="423.5" y="2653.4966">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="445.5" y="2653.4966">Return success</text><path d="M411,2678.5625 L411,3051.5625 L726,3051.5625 L726,2688.5625 L716,2678.5625 L411,2678.5625 " fill="#FFFF00" filter="url(#fydmojfywr5sg)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M716,2678.5625 L716,2688.5625 L726,2688.5625 L716,2678.5625 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="417" y="2695.6294">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="417" y="2710.7622">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="433" y="2725.895">id: &lt;ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="267" x="433" y="2741.0278">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="433" y="2756.1606">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="433" y="2771.2935">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="433" y="2786.4263">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="449" y="2801.5591">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="449" y="2816.6919">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="433" y="2831.8247">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="433" y="2846.9575">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="449" y="2862.0903">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="465" y="2877.2231">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="465" y="2892.356">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="465" y="2907.4888">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="465" y="2922.6216">action: commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="465" y="2937.7544">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="465" y="2952.8872">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="481" y="2968.02">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="481" y="2983.1528">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="465" y="2998.2856">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="449" y="3013.4185">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="433" y="3028.5513">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="417" y="3043.6841">}</text><polygon fill="#A80036" points="1006.5,3077.8828,1016.5,3081.8828,1006.5,3085.8828,1010.5,3081.8828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="406.5" x2="1012.5" y1="3081.8828" y2="3081.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413.5" y="3076.8169">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="435.5" y="3076.8169">Route &amp; Publish Position event for Payee</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="313.5" x2="1949" y1="3120.8828" y2="3120.8828"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="255" x="318.5" y="3131.0933">[Validate Fulfil Transfer not successful]</text><path d="M323.5,3141.6875 L411.5,3141.6875 L411.5,3148.6875 L401.5,3158.6875 L323.5,3158.6875 L323.5,3141.6875 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="76.2656" style="stroke: #000000; stroke-width: 2.0;" width="1062" x="323.5" y="3141.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="338.5" y="3154.7544">break</text><polygon fill="#A80036" points="1288,3175.9531,1298,3179.9531,1288,3183.9531,1292,3179.9531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="406.5" x2="1294" y1="3179.9531" y2="3179.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413.5" y="3174.8872">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="435.5" y="3174.8872">Route &amp; Publish Notification event for Payee</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="2026" y1="3239.9531" y2="3239.9531"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="28" y="3250.1636">[Consume Batch Messages]</text><path d="M172,3258.7578 L172,3283.7578 L387,3283.7578 L387,3268.7578 L377,3258.7578 L172,3258.7578 " fill="#ADD8E6" filter="url(#fydmojfywr5sg)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M377,3258.7578 L377,3268.7578 L387,3268.7578 L377,3258.7578 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="178" y="3275.8247">To be delivered by future story</text><!--
@startuml
title 2.1.1. Fulfil Handler Consume (Success)
autonumber
collections "Fulfil-Topic" as TOPIC_FULFIL
control "Fulfil Event Handler" as FULF_HANDLER
collections "Event-Topic" as TOPIC_EVENT
collections "topic-transfer-position" as TOPIC_TRANSFER_POSITION
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Transfer DAO" as TRANS_DAO
database "Central Store" as DB
box "Central Service" #LightYellow
    participant TOPIC_FULFIL
    participant FULF_HANDLER
    participant TOPIC_TRANSFER_POSITION
    participant TOPIC_EVENT
    participant TOPIC_NOTIFICATIONS
    participant TRANS_DAO
    participant DB
end box
activate FULF_HANDLER
group Fulfil Handler Consume (Success)
    alt Consume Single Message
        TOPIC_FULFIL <- FULF_HANDLER: Consume Prepare event message for Payer
        activate TOPIC_FULFIL
        deactivate TOPIC_FULFIL
        break
            group Validate Event
                FULF_HANDLER <-> FULF_HANDLER: Validate event - Rule: type == 'fulfil' && action == 'commit'\n<color #FF0000><b>Error codes:</b> 2001</color>
            end
        end
        group Persist Event Information
            FULF_HANDLER -> TOPIC_EVENT: Publish event information
            ref over FULF_HANDLER, TOPIC_EVENT:  Event Handler Consume {[[https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg 9.1.0.]]}
        end
        group Validate FSPIOP-Signature
            |||
            ref over FULF_HANDLER, TOPIC_NOTIFICATIONS: Validate message.content.headers.**FSPIOP-Signature** {[[https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-signature-validation.svg seq-signature-validation]]} \n<color #FF0000><b>Error codes:</b> 3105/3106</color>
        end
        group Validate Transfer Fulfilment Duplicate Check
            FULF_HANDLER -> FULF_HANDLER: Generate transferFulfilmentId uuid
            FULF_HANDLER -> TRANS_DAO: Request to retrieve transfer fulfilment hashes by transferId\n<color #FF0000><b>Error code:</b> 2003</color>
            activate TRANS_DAO
            TRANS_DAO -> DB: Request Transfer fulfilment duplicate message hashes
            hnote over DB #lightyellow
                SELET transferId, hash
                FROM **transferFulfilmentDuplicateCheck**
                WHERE transferId = request.params.id
            end note
            activate DB
            TRANS_DAO <- - DB: Return existing hashes
            deactivate DB
            TRANS_DAO - -> FULF_HANDLER: Return (list of) transfer fulfil messages hash(es)
            deactivate TRANS_DAO
            FULF_HANDLER -> FULF_HANDLER: Loop the list of returned hashes and compare each entry with the calculated message hash
            alt Hash matched
                FULF_HANDLER -> TOPIC_EVENT: Publish event information (for duplicate) ( Event Handler Consume {[[https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg 9.1.0]]} )
                FULF_HANDLER -> TRANS_DAO: Request to retrieve Transfer Fulfilment and Transfer state\n<color #FF0000><b>Error code:</b> 2003</color>
                activate TRANS_DAO
                TRANS_DAO -> DB: Request to retrieve Transfer Fulfilment and Transfer state
                hnote over DB #lightyellow
                    transferFulfilment
                    transferStateChange
                end note
                activate DB
                TRANS_DAO <- - DB: Return Transfer Fulfilment and Transfer state
                deactivate DB
                TRANS_DAO - -> FULF_HANDLER: Return Transfer Fulfilment and Transfer state
                deactivate TRANS_DAO
                alt transferFulfilment.isValid == 0
                    break
                        FULF_HANDLER <-> FULF_HANDLER: <color #FF0000><b>Error handling:</b> 3106</color>
                    end
                else transferState IN ['COMMITTED', 'ABORTED']
                    break
                        ref over FULF_HANDLER, TOPIC_NOTIFICATIONS: Send notification to Participant (Payee) {[[https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-prepare-1.1.4.a.svg 1.1.4.a.]]} \n
                    end
                else transferState NOT 'RESERVED'
                    break
                        FULF_HANDLER <-> FULF_HANDLER: <color #FF0000><b>Error code:</b> 2001</color>
                    end
                else
                    break
                        FULF_HANDLER <-> FULF_HANDLER: Allow previous request to complete
                    end
                end
            else Hash not matched
                FULF_HANDLER -> TRANS_DAO: Request to persist transfer hash\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate TRANS_DAO
                TRANS_DAO -> DB: Persist hash
                hnote over DB #lightyellow
                    transferFulfilmentDuplicateCheck
                end note
                activate DB
                deactivate DB
                TRANS_DAO - -> FULF_HANDLER: Return success
                deactivate TRANS_DAO
            end
        end
        group Validate and persist Transfer Fulfilment
            FULF_HANDLER -> TRANS_DAO: Request information for the validate checks\n<color #FF0000><b>Error code:</b> 2003</color>
            activate TRANS_DAO
            TRANS_DAO -> DB: Fetch from database
            activate DB
            hnote over DB #lightyellow
                transfer
            end note
            DB - -> TRANS_DAO
            deactivate DB
            FULF_HANDLER <- - TRANS_DAO: Return transfer
            deactivate TRANS_DAO
            FULF_HANDLER ->FULF_HANDLER: Validate that Transfer.ilpCondition = SHA-256 (content.payload.fulfilment)\n<color #FF0000><b>Error code:</b> 2001</color>
            FULF_HANDLER -> FULF_HANDLER: Validate expirationDate\n<color #FF0000><b>Error code:</b> 3303</color>

            opt Transfer.ilpCondition validate successful
                group Request current Settlement Window
                    FULF_HANDLER -> TRANS_DAO: Request to retrieve current/latest transfer settlement window\n<color #FF0000><b>Error code:</b> 2003</color>
                    activate TRANS_DAO
                    TRANS_DAO -> DB: Fetch settlementWindowId
                    activate DB
                    DB - -> TRANS_DAO
                    hnote over DB #lightyellow
                        settlementWindow
                    end note
                    deactivate DB
                    FULF_HANDLER <- - TRANS_DAO: Return settlementWindowId to be appended during transferFulfilment insert\n**TODO**: During settlement design make sure transfers in 'RECEIVED-FULFIL'\nstate are updated to the next settlement window
                    deactivate TRANS_DAO
                end
            end

            group Persist fulfilment
                FULF_HANDLER -> TRANS_DAO: Persist fulfilment with the result of the above check (transferFulfilment.isValid)\n<color #FF0000><b>Error code:</b> 2003</color>
                activate TRANS_DAO
                TRANS_DAO -> DB: Persist to database
                activate DB
                deactivate DB
                hnote over DB #lightyellow
                    transferFulfilment
                    transferExtension
                end note
                FULF_HANDLER <- - TRANS_DAO: Return success
                deactivate TRANS_DAO
            end

            alt Transfer.ilpCondition validate successful
                group Persist Transfer State (with transferState='RECEIVED-FULFIL')
                    FULF_HANDLER -> TRANS_DAO: Request to persist transfer state\n<color #FF0000><b>Error code:</b> 2003</color>
                    activate TRANS_DAO
                    TRANS_DAO -> DB: Persist transfer state
                    activate DB
                    hnote over DB #lightyellow
                        transferStateChange
                    end note
                    deactivate DB
                    TRANS_DAO - -> FULF_HANDLER: Return success
                end



                note right of FULF_HANDLER #yellow
                    Message:
                    {
                        id: <ID>,
                        from: <transferHeaders.FSPIOP-Source>,
                        to: <transferHeaders.FSPIOP-Destination>,
                        type: application/json,
                        content: {
                            headers: <transferHeaders>,
                            payload: <transferMessage>
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                responseTo: <previous.uuid>,
                                type: position,
                                action: commit,
                                createdAt: <timestamp>,
                                state: {
                                    status: "success",
                                    code: 0
                                }
                            }
                        }
                    }
                end note
                FULF_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event for Payee
                activate TOPIC_TRANSFER_POSITION
                deactivate TOPIC_TRANSFER_POSITION
            else Validate Fulfil Transfer not successful
                break
                    FULF_HANDLER -> TOPIC_NOTIFICATIONS: Route & Publish Notification event for Payee
                    activate TOPIC_NOTIFICATIONS
                    deactivate TOPIC_NOTIFICATIONS
                end
            end
        end
    else Consume Batch Messages
        note left of FULF_HANDLER #lightblue
            To be delivered by future story
        end note
    end
end
deactivate FULF_HANDLER
@enduml

PlantUML version 1.2018.12(Sun Oct 21 05:15:15 CDT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_191-8u191-b12-0ubuntu0.16.04.1-b12
Operating System: Linux
OS Version: 4.4.0-31-generic
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>