<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3019px" preserveAspectRatio="none" style="width:2000px;height:3019px;" version="1.1" viewBox="0 0 2000 3019" width="2000px" zoomAndPan="magnify"><defs><filter height="300%" id="f1q7wvjpkbxj6p" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="412" x="795" y="22.9951">1.1.2.a. Position Handler Consume (single message)</text><rect fill="#FFFFE0" height="2974.1406" style="stroke: #A80036; stroke-width: 1.0;" width="1913.5" x="19" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="920.25" y="46.3638">Central Service</text><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="105" y="170.9922"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="2785.4141" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="426" y="125.7266"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1049" y="1678.5625"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1304.5" y="2881.1406"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1433" y="553.4531"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1433" y="952.1797"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1433" y="1776.6328"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1547.5" y="703.1172"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1547.5" y="1926.2969"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1663" y="1133.8438"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1663" y="2245.625"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1875.5" y="582.5859"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1875.5" y="732.25"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1875.5" y="981.3125"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1875.5" y="1162.9766"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1875.5" y="1805.7656"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1875.5" y="1955.4297"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1875.5" y="2274.7578"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="2793.4141" style="stroke: #000000; stroke-width: 2.0;" width="1976" x="13" y="132.7266"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="90.3984" style="stroke: #000000; stroke-width: 2.0;" width="556.5" x="330.5" y="215.9922"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="536.5" x="340.5" y="240.125"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="156.6641" style="stroke: #000000; stroke-width: 2.0;" width="898.5" x="340.5" y="320.3906"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="2428.0859" style="stroke: #000000; stroke-width: 2.0;" width="1648.5" x="330.5" y="491.0547"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="566.3906" style="stroke: #000000; stroke-width: 2.0;" width="1611.5" x="340.5" y="515.1875"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="167.6641" style="stroke: #000000; stroke-width: 2.0;" width="1628.5" x="340.5" y="1095.5781"/><rect fill="#FFFFFF" height="1202.5781" style="stroke: none; stroke-width: 1.0;" width="1648.5" x="330.5" y="1716.5625"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="454.9922" style="stroke: #000000; stroke-width: 2.0;" width="1611.5" x="340.5" y="1738.3672"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="167.6641" style="stroke: #000000; stroke-width: 2.0;" width="1628.5" x="340.5" y="2207.3594"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="110" x2="110" y1="115.7266" y2="2943.1406"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="430.5" x2="430.5" y1="115.7266" y2="2943.1406"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1054" x2="1054" y1="115.7266" y2="2943.1406"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1177" x2="1177" y1="115.7266" y2="2943.1406"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1309" x2="1309" y1="115.7266" y2="2943.1406"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1438" x2="1438" y1="115.7266" y2="2943.1406"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1552" x2="1552" y1="115.7266" y2="2943.1406"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1668" x2="1668" y1="115.7266" y2="2943.1406"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1880.5" x2="1880.5" y1="115.7266" y2="2943.1406"/><rect fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="27" y="76.4297"/><rect fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="23" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="30" y="100.4248">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="27" y="2942.1406"/><rect fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="23" y="2946.1406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="30" y="2966.1357">topic-transfer-position</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="155" x="350.5" y="112.4248">Position Event Handler</text><ellipse cx="431" cy="83.4297" fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="427,71.4297,433,66.4297,431,71.4297,433,76.4297,427,71.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="155" x="350.5" y="2955.1357">Position Event Handler</text><ellipse cx="431" cy="2974.4375" fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="427,2962.4375,433,2957.4375,431,2962.4375,433,2967.4375,427,2962.4375" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="997" y="76.4297"/><rect fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="993" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="1000" y="100.4248">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="997" y="2942.1406"/><rect fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="993" y="2946.1406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="1000" y="2966.1357">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="1129" y="76.4297"/><rect fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="1125" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1132" y="100.4248">Event-Topic</text><rect fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="1129" y="2942.1406"/><rect fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="1125" y="2946.1406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="1132" y="2966.1357">Event-Topic</text><rect fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="1243" y="76.4297"/><rect fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="1239" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="1246" y="100.4248">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="1243" y="2942.1406"/><rect fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="1239" y="2946.1406"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="1246" y="2966.1357">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1390" y="112.4248">Position DAO</text><ellipse cx="1438" cy="83.4297" fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1426" x2="1450" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1390" y="2955.1357">Position DAO</text><ellipse cx="1438" cy="2974.4375" fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1426" x2="1450" y1="2988.4375" y2="2988.4375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="107" x="1496" y="112.4248">Participant DAO</text><ellipse cx="1552.5" cy="83.4297" fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1540.5" x2="1564.5" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="107" x="1496" y="2955.1357">Participant DAO</text><ellipse cx="1552.5" cy="2974.4375" fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1540.5" x2="1564.5" y1="2988.4375" y2="2988.4375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="1619" y="112.4248">Transfer DAO</text><ellipse cx="1668" cy="83.4297" fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1656" x2="1680" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="1619" y="2955.1357">Transfer DAO</text><ellipse cx="1668" cy="2974.4375" fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1656" x2="1680" y1="2988.4375" y2="2988.4375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1832.5" y="112.4248">Central Store</text><path d="M1862.5,63.4297 C1862.5,53.4297 1880.5,53.4297 1880.5,53.4297 C1880.5,53.4297 1898.5,53.4297 1898.5,63.4297 L1898.5,89.4297 C1898.5,99.4297 1880.5,99.4297 1880.5,99.4297 C1880.5,99.4297 1862.5,99.4297 1862.5,89.4297 L1862.5,63.4297 " fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1862.5,63.4297 C1862.5,73.4297 1880.5,73.4297 1880.5,73.4297 C1880.5,73.4297 1898.5,73.4297 1898.5,63.4297 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1832.5" y="2955.1357">Central Store</text><path d="M1862.5,2968.4375 C1862.5,2958.4375 1880.5,2958.4375 1880.5,2958.4375 C1880.5,2958.4375 1898.5,2958.4375 1898.5,2968.4375 L1898.5,2994.4375 C1898.5,3004.4375 1880.5,3004.4375 1880.5,3004.4375 C1880.5,3004.4375 1862.5,3004.4375 1862.5,2994.4375 L1862.5,2968.4375 " fill="#FEFECE" filter="url(#f1q7wvjpkbxj6p)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1862.5,2968.4375 C1862.5,2978.4375 1880.5,2978.4375 1880.5,2978.4375 C1880.5,2978.4375 1898.5,2978.4375 1898.5,2968.4375 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="105" y="170.9922"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="2785.4141" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="426" y="125.7266"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1049" y="1678.5625"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1304.5" y="2881.1406"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1433" y="553.4531"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1433" y="952.1797"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="120.5313" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1433" y="1776.6328"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1547.5" y="703.1172"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1547.5" y="1926.2969"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1663" y="1133.8438"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1663" y="2245.625"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1875.5" y="582.5859"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1875.5" y="732.25"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1875.5" y="981.3125"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1875.5" y="1162.9766"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="62.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1875.5" y="1805.7656"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1875.5" y="1955.4297"/><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1875.5" y="2274.7578"/><path d="M13,132.7266 L253,132.7266 L253,139.7266 L243,149.7266 L13,149.7266 L13,132.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2793.4141" style="stroke: #000000; stroke-width: 2.0;" width="1976" x="13" y="132.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="195" x="28" y="145.7935">Position Handler Consume</text><polygon fill="#A80036" points="126,166.9922,116,170.9922,126,174.9922,122,170.9922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="120" x2="425" y1="170.9922" y2="170.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="132" y="165.9263">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="279" x="145" y="165.9263">Consume Position event message for Payer</text><path d="M330.5,215.9922 L418.5,215.9922 L418.5,222.9922 L408.5,232.9922 L330.5,232.9922 L330.5,215.9922 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="90.3984" style="stroke: #000000; stroke-width: 2.0;" width="556.5" x="330.5" y="215.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="345.5" y="229.0591">break</text><path d="M340.5,240.125 L492.5,240.125 L492.5,247.125 L482.5,257.125 L340.5,257.125 L340.5,240.125 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="536.5" x="340.5" y="240.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="107" x="355.5" y="253.1919">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="436" x2="478" y1="278.3906" y2="278.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="478" x2="478" y1="278.3906" y2="291.3906"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="437" x2="478" y1="291.3906" y2="291.3906"/><polygon fill="#A80036" points="447,287.3906,437,291.3906,447,295.3906,443,291.3906" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="443" y="273.3247">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="409" x="456" y="273.3247">Validate event - Rule: type == 'position' &amp;&amp; action == 'prepare'</text><path d="M340.5,320.3906 L572.5,320.3906 L572.5,327.3906 L562.5,337.3906 L340.5,337.3906 L340.5,320.3906 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="156.6641" style="stroke: #000000; stroke-width: 2.0;" width="898.5" x="340.5" y="320.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="187" x="355.5" y="333.4575">Persist Event Information</text><polygon fill="#A80036" points="1165,379.6563,1175,383.6563,1165,387.6563,1169,383.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436" x2="1171" y1="383.6563" y2="383.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="443" y="378.5903">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="456" y="378.5903">Publish event information</text><rect fill="#FFFFFF" filter="url(#f1q7wvjpkbxj6p)" height="55.3984" style="stroke: #000000; stroke-width: 2.0;" width="880.5" x="347.5" y="391.6563"/><polygon fill="#EEEEEE" points="347.5,391.6563,413.5,391.6563,413.5,398.6563,403.5,408.6563,347.5,408.6563,347.5,391.6563" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="360.5" y="405.7231">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="682.25" y="424.7231">Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="36" x="849.25" y="424.7231">9.1.0.</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="849.25" x2="885.25" y1="426.7231" y2="426.7231"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="885.25" y="424.7231">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="686.25" y="439.856"/><path d="M330.5,491.0547 L394.5,491.0547 L394.5,498.0547 L384.5,508.0547 L330.5,508.0547 L330.5,491.0547 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2428.0859" style="stroke: #000000; stroke-width: 2.0;" width="1648.5" x="330.5" y="491.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="345.5" y="504.1216">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="300" x="409.5" y="503.2651">[Calulate &amp; Validate Latest Position (success)]</text><path d="M340.5,515.1875 L665.5,515.1875 L665.5,522.1875 L655.5,532.1875 L340.5,532.1875 L340.5,515.1875 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="566.3906" style="stroke: #000000; stroke-width: 2.0;" width="1611.5" x="340.5" y="515.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="280" x="355.5" y="528.2544">Calculate position and persist change</text><polygon fill="#A80036" points="1421,549.4531,1431,553.4531,1421,557.4531,1425,553.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436" x2="1427" y1="553.4531" y2="553.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="443" y="548.3872">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="456" y="548.3872">Request latest position from DB for Payer</text><polygon fill="#A80036" points="1863.5,578.5859,1873.5,582.5859,1863.5,586.5859,1867.5,582.5859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1443" x2="1869.5" y1="582.5859" y2="582.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1450" y="577.52">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="1463" y="577.52">Retrieve latest position from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f1q7wvjpkbxj6p)" points="1828,595.5859,1932,595.5859,1942,606.5859,1932,618.5859,1828,618.5859,1818,606.5859,1828,595.5859" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1830" y="611.6528">transferPosition</text><polygon fill="#A80036" points="1454,640.8516,1444,644.8516,1454,648.8516,1450,644.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1448" x2="1879.5" y1="644.8516" y2="644.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1460" y="639.7856">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="1473" y="639.7856">Retrieve latest position from DB for Payer</text><polygon fill="#A80036" points="447,669.9844,437,673.9844,447,677.9844,443,673.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="441" x2="1437" y1="673.9844" y2="673.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="453" y="668.9185">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="466" y="668.9185">Return latest position</text><polygon fill="#A80036" points="1535.5,699.1172,1545.5,703.1172,1535.5,707.1172,1539.5,703.1172" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436" x2="1541.5" y1="703.1172" y2="703.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="443" y="698.0513">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="456" y="698.0513">Request position limits for Payer Participant</text><polygon fill="#A80036" points="1863.5,728.25,1873.5,732.25,1863.5,736.25,1867.5,732.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1557.5" x2="1869.5" y1="732.25" y2="732.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1564.5" y="727.1841">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="1577.5" y="727.1841">Request position limits for Payer Participant</text><polygon fill="#FFFFE0" filter="url(#f1q7wvjpkbxj6p)" points="1829,745.25,1932,745.25,1942,764.25,1932,783.25,1829,783.25,1819,764.25,1829,745.25" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1831" y="761.3169">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="1831" y="776.4497">participantLimit</text><polygon fill="#A80036" points="1568.5,805.6484,1558.5,809.6484,1568.5,813.6484,1564.5,809.6484" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1562.5" x2="1879.5" y1="809.6484" y2="809.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1574.5" y="804.5825">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1596.5" y="804.5825">Return position limits</text><polygon fill="#A80036" points="447,834.7813,437,838.7813,447,842.7813,443,838.7813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="441" x2="1551.5" y1="838.7813" y2="838.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="453" y="833.7153">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="475" y="833.7153">Return position limits</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="436" x2="478" y1="867.9141" y2="867.9141"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="478" x2="478" y1="867.9141" y2="880.9141"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="437" x2="478" y1="880.9141" y2="880.9141"/><polygon fill="#A80036" points="447,876.9141,437,880.9141,447,884.9141,443,880.9141" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="443" y="862.8481">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="465" y="862.8481">Calculate latest position (lpos) for prepare</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="436" x2="478" y1="910.0469" y2="910.0469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="478" x2="478" y1="910.0469" y2="923.0469"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="437" x2="478" y1="923.0469" y2="923.0469"/><polygon fill="#A80036" points="447,919.0469,437,923.0469,447,927.0469,443,923.0469" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="443" y="904.981">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="577" x="465" y="904.981">Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos &lt; netcap</text><polygon fill="#A80036" points="1421,948.1797,1431,952.1797,1421,956.1797,1425,952.1797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436" x2="1427" y1="952.1797" y2="952.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="443" y="947.1138">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="465" y="947.1138">Request to persist latest position for Payer</text><polygon fill="#A80036" points="1863.5,977.3125,1873.5,981.3125,1863.5,985.3125,1867.5,981.3125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1443" x2="1869.5" y1="981.3125" y2="981.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1450" y="976.2466">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="1472" y="976.2466">Persist latest position to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f1q7wvjpkbxj6p)" points="1828,1024.3125,1932,1024.3125,1942,1035.3125,1932,1047.3125,1828,1047.3125,1818,1035.3125,1828,1024.3125" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1830" y="1040.3794">transferPosition</text><polygon fill="#A80036" points="447,1069.5781,437,1073.5781,447,1077.5781,443,1073.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="441" x2="1437" y1="1073.5781" y2="1073.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="453" y="1068.5122">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="475" y="1068.5122">Return success</text><path d="M340.5,1095.5781 L968.5,1095.5781 L968.5,1102.5781 L958.5,1112.5781 L340.5,1112.5781 L340.5,1095.5781 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="167.6641" style="stroke: #000000; stroke-width: 2.0;" width="1628.5" x="340.5" y="1095.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="583" x="355.5" y="1108.645">Persist Transfer State (with transferState='RESERVED' on position check pass)</text><polygon fill="#A80036" points="1651,1129.8438,1661,1133.8438,1651,1137.8438,1655,1133.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436" x2="1657" y1="1133.8438" y2="1133.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="443" y="1128.7778">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="465" y="1128.7778">Request to persist transfer</text><polygon fill="#A80036" points="1863.5,1158.9766,1873.5,1162.9766,1863.5,1166.9766,1867.5,1162.9766" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1673" x2="1869.5" y1="1162.9766" y2="1162.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1680" y="1157.9106">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1702" y="1157.9106">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f1q7wvjpkbxj6p)" points="1811,1205.9766,1949,1205.9766,1959,1216.9766,1949,1228.9766,1811,1228.9766,1801,1216.9766,1811,1205.9766" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1813" y="1222.0435">transferStateChange</text><polygon fill="#A80036" points="447,1251.2422,437,1255.2422,447,1259.2422,443,1255.2422" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="441" x2="1667" y1="1255.2422" y2="1255.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="453" y="1250.1763">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="475" y="1250.1763">Return success</text><path d="M441,1275.2422 L441,1648.2422 L711,1648.2422 L711,1285.2422 L701,1275.2422 L441,1275.2422 " fill="#FFFF00" filter="url(#f1q7wvjpkbxj6p)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M701,1275.2422 L701,1285.2422 L711,1285.2422 L701,1275.2422 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="447" y="1292.3091">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="447" y="1307.4419">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="463" y="1322.5747">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="463" y="1337.7075">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="463" y="1352.8403">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="463" y="1367.9731">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="463" y="1383.106">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="479" y="1398.2388">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="479" y="1413.3716">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="463" y="1428.5044">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="463" y="1443.6372">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="479" y="1458.77">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="495" y="1473.9028">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="495" y="1489.0356">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="495" y="1504.1685">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="495" y="1519.3013">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="495" y="1534.4341">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="495" y="1549.5669">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="511" y="1564.6997">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="511" y="1579.8325">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="495" y="1594.9653">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="479" y="1610.0981">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="463" y="1625.231">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="447" y="1640.3638">}</text><polygon fill="#A80036" points="1037,1674.5625,1047,1678.5625,1037,1682.5625,1041,1678.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436" x2="1043" y1="1678.5625" y2="1678.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="443" y="1673.4966">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="465" y="1673.4966">Publish Transfer event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="330.5" x2="1979" y1="1717.5625" y2="1717.5625"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="298" x="335.5" y="1727.7729">[Calculate &amp; Validate Latest Position (failure)]</text><path d="M340.5,1738.3672 L665.5,1738.3672 L665.5,1745.3672 L655.5,1755.3672 L340.5,1755.3672 L340.5,1738.3672 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="454.9922" style="stroke: #000000; stroke-width: 2.0;" width="1611.5" x="340.5" y="1738.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="280" x="355.5" y="1751.4341">Calculate position and persist change</text><polygon fill="#A80036" points="1421,1772.6328,1431,1776.6328,1421,1780.6328,1425,1776.6328" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436" x2="1427" y1="1776.6328" y2="1776.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="443" y="1771.5669">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="465" y="1771.5669">Request latest position from DB for Payer</text><polygon fill="#A80036" points="1863.5,1801.7656,1873.5,1805.7656,1863.5,1809.7656,1867.5,1805.7656" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1443" x2="1869.5" y1="1805.7656" y2="1805.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1450" y="1800.6997">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="1472" y="1800.6997">Retrieve latest position from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f1q7wvjpkbxj6p)" points="1828,1818.7656,1932,1818.7656,1942,1829.7656,1932,1841.7656,1828,1841.7656,1818,1829.7656,1828,1818.7656" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1830" y="1834.8325">transferPosition</text><polygon fill="#A80036" points="1454,1864.0313,1444,1868.0313,1454,1872.0313,1450,1868.0313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1448" x2="1879.5" y1="1868.0313" y2="1868.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1460" y="1862.9653">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="1482" y="1862.9653">Retrieve latest position from DB for Payer</text><polygon fill="#A80036" points="447,1893.1641,437,1897.1641,447,1901.1641,443,1897.1641" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="441" x2="1437" y1="1897.1641" y2="1897.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="453" y="1892.0981">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="475" y="1892.0981">Return latest position</text><polygon fill="#A80036" points="1535.5,1922.2969,1545.5,1926.2969,1535.5,1930.2969,1539.5,1926.2969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436" x2="1541.5" y1="1926.2969" y2="1926.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="443" y="1921.231">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="465" y="1921.231">Request position limits for Payer Participant</text><polygon fill="#A80036" points="1863.5,1951.4297,1873.5,1955.4297,1863.5,1959.4297,1867.5,1955.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1557.5" x2="1869.5" y1="1955.4297" y2="1955.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1564.5" y="1950.3638">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="1586.5" y="1950.3638">Request position limits for Payer Participant</text><polygon fill="#FFFFE0" filter="url(#f1q7wvjpkbxj6p)" points="1829,1968.4297,1932,1968.4297,1942,1987.4297,1932,2006.4297,1829,2006.4297,1819,1987.4297,1829,1968.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1831" y="1984.4966">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="1831" y="1999.6294">participantLimit</text><polygon fill="#A80036" points="1568.5,2028.8281,1558.5,2032.8281,1568.5,2036.8281,1564.5,2032.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1562.5" x2="1879.5" y1="2032.8281" y2="2032.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1574.5" y="2027.7622">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1596.5" y="2027.7622">Return position limits</text><polygon fill="#A80036" points="447,2057.9609,437,2061.9609,447,2065.9609,443,2061.9609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="441" x2="1551.5" y1="2061.9609" y2="2061.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="453" y="2056.895">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="475" y="2056.895">Return position limits</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="436" x2="478" y1="2091.0938" y2="2091.0938"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="478" x2="478" y1="2091.0938" y2="2104.0938"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="437" x2="478" y1="2104.0938" y2="2104.0938"/><polygon fill="#A80036" points="447,2100.0938,437,2104.0938,447,2108.0938,443,2104.0938" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="443" y="2086.0278">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="465" y="2086.0278">Calculate latest position (lpos) for prepare</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="436" x2="478" y1="2133.2266" y2="2133.2266"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="478" x2="478" y1="2133.2266" y2="2146.2266"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="437" x2="478" y1="2146.2266" y2="2146.2266"/><polygon fill="#A80036" points="447,2142.2266,437,2146.2266,447,2150.2266,443,2146.2266" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="443" y="2128.1606">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="577" x="465" y="2128.1606">Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos &lt; netcap</text><path d="M441,2159.2266 L441,2184.2266 L573,2184.2266 L573,2169.2266 L563,2159.2266 L441,2159.2266 " fill="#FF0000" filter="url(#f1q7wvjpkbxj6p)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M563,2159.2266 L563,2169.2266 L573,2169.2266 L563,2159.2266 " fill="#FF0000" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="447" y="2176.2935">Validation failure!</text><path d="M340.5,2207.3594 L960.5,2207.3594 L960.5,2214.3594 L950.5,2224.3594 L340.5,2224.3594 L340.5,2207.3594 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="167.6641" style="stroke: #000000; stroke-width: 2.0;" width="1628.5" x="340.5" y="2207.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="575" x="355.5" y="2220.4263">Persist Transfer State (with transferState='ABORTED' on position check pass)</text><polygon fill="#A80036" points="1651,2241.625,1661,2245.625,1651,2249.625,1655,2245.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436" x2="1657" y1="2245.625" y2="2245.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="443" y="2240.5591">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="465" y="2240.5591">Request to persist transfer</text><polygon fill="#A80036" points="1863.5,2270.7578,1873.5,2274.7578,1863.5,2278.7578,1867.5,2274.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1673" x2="1869.5" y1="2274.7578" y2="2274.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1680" y="2269.6919">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1702" y="2269.6919">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f1q7wvjpkbxj6p)" points="1811,2317.7578,1949,2317.7578,1959,2328.7578,1949,2340.7578,1811,2340.7578,1801,2328.7578,1811,2317.7578" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1813" y="2333.8247">transferStateChange</text><polygon fill="#A80036" points="447,2363.0234,437,2367.0234,447,2371.0234,443,2367.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="441" x2="1667" y1="2367.0234" y2="2367.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="453" y="2361.9575">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="475" y="2361.9575">Return success</text><path d="M441,2387.0234 L441,2850.0234 L849,2850.0234 L849,2397.0234 L839,2387.0234 L441,2387.0234 " fill="#FFFF00" filter="url(#f1q7wvjpkbxj6p)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M839,2387.0234 L839,2397.0234 L849,2397.0234 L839,2387.0234 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="447" y="2404.0903">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="447" y="2419.2231">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="463" y="2434.356">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="463" y="2449.4888">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="463" y="2464.6216">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="463" y="2479.7544">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="463" y="2494.8872">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="479" y="2510.02">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="479" y="2525.1528">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="495" y="2540.2856">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="511" y="2555.4185">"errorCode": 4001,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="323" x="511" y="2570.5513">"errorDescription": "Payer FSP insufficient liquidity",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="511" y="2585.6841">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="479" y="2600.8169">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="463" y="2615.9497">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="463" y="2631.0825">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="479" y="2646.2153">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="495" y="2661.3481">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="495" y="2676.481">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="495" y="2691.6138">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="495" y="2706.7466">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="495" y="2721.8794">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="495" y="2737.0122">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="511" y="2752.145">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="511" y="2767.2778">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="511" y="2782.4106">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="495" y="2797.5435">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="479" y="2812.6763">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="463" y="2827.8091">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="447" y="2842.9419">}</text><polygon fill="#A80036" points="1292.5,2877.1406,1302.5,2881.1406,1292.5,2885.1406,1296.5,2881.1406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="436" x2="1298.5" y1="2881.1406" y2="2881.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="443" y="2876.0747">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="465" y="2876.0747">Publish Notification (failure) event for Payer</text><!--
@startuml
title 1.1.2.a. Position Handler Consume (single message)

autonumber


collections "topic-transfer-position" as TOPIC_TRANSFER_POSITION
control "Position Event Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
entity "Position DAO" as POS_DAO
collections "Event-Topic" as TOPIC_EVENTS
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Participant DAO" as PARTICIPANT_DAO
entity "Transfer DAO" as TRANS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_TRANSFER_POSITION
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant PARTICIPANT_DAO
    participant TRANS_DAO
    participant DB
end box

activate POS_HANDLER
group Position Handler Consume
    TOPIC_TRANSFER_POSITION <- POS_HANDLER: Consume Position event message for Payer
    activate TOPIC_TRANSFER_POSITION
    deactivate TOPIC_TRANSFER_POSITION

    break
        group Validate Event
            POS_HANDLER <-> POS_HANDLER: Validate event - Rule: type == 'position' && action == 'prepare'
        end
    end

    group Persist Event Information
        |||
        POS_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over POS_HANDLER, TOPIC_EVENTS :  Event Handler Consume {[[https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg 9.1.0.]]} \n
        |||
    end

    alt Calulate & Validate Latest Position (success)
        group Calculate position and persist change
            POS_HANDLER -> POS_DAO: Request latest position from DB for Payer
            activate POS_DAO
            POS_DAO -> DB: Retrieve latest position from DB for Payer
            activate DB
            hnote over DB #lightyellow
                transferPosition
            end note
            DB - -> POS_DAO: Retrieve latest position from DB for Payer
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return latest position
            deactivate POS_DAO

            POS_HANDLER -> PARTICIPANT_DAO: Request position limits for Payer Participant
            activate PARTICIPANT_DAO
            PARTICIPANT_DAO -> DB: Request position limits for Payer Participant
            activate DB
            hnote over DB #lightyellow
                participant
                participantLimit
            end note
            DB - -> PARTICIPANT_DAO: Return position limits
            deactivate DB
            deactivate DB
            PARTICIPANT_DAO - -> POS_HANDLER: Return position limits
            deactivate PARTICIPANT_DAO

            POS_HANDLER <-> POS_HANDLER: Calculate latest position (lpos) for prepare
            POS_HANDLER <-> POS_HANDLER: Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos < netcap
            
            POS_HANDLER -> POS_DAO: Request to persist latest position for Payer
            activate POS_DAO
            POS_DAO -> DB: Persist latest position to DB for Payer
            hnote over DB #lightyellow
                transferPosition
            end note
            activate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end

        group Persist Transfer State (with transferState='RESERVED' on position check pass)
            POS_HANDLER -> TRANS_DAO: Request to persist transfer
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist transfer state
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end

        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event
        activate TOPIC_TRANSFERS
        deactivate TOPIC_TRANSFERS
    else Calculate & Validate Latest Position (failure)
        group Calculate position and persist change
            POS_HANDLER -> POS_DAO: Request latest position from DB for Payer
            activate POS_DAO
            POS_DAO -> DB: Retrieve latest position from DB for Payer
            activate DB
            hnote over DB #lightyellow
                transferPosition
            end note
            DB - -> POS_DAO: Retrieve latest position from DB for Payer
            deactivate DB
            deactivate DB
            POS_DAO - -> POS_HANDLER: Return latest position
            deactivate POS_DAO

            POS_HANDLER -> PARTICIPANT_DAO: Request position limits for Payer Participant
            activate PARTICIPANT_DAO
            PARTICIPANT_DAO -> DB: Request position limits for Payer Participant
            activate DB
            hnote over DB #lightyellow
                participant
                participantLimit
            end note
            DB - -> PARTICIPANT_DAO: Return position limits
            deactivate DB
            deactivate DB
            PARTICIPANT_DAO - -> POS_HANDLER: Return position limits
            deactivate PARTICIPANT_DAO

            POS_HANDLER <-> POS_HANDLER: Calculate latest position (lpos) for prepare
            POS_HANDLER <-> POS_HANDLER: Validate Calculated latest position against the net-debit cap (netcap) - Rule: lpos < netcap
            note right of POS_HANDLER #red: Validation failure!
        end
        
        group Persist Transfer State (with transferState='ABORTED' on position check pass)
            POS_HANDLER -> TRANS_DAO: Request to persist transfer
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist transfer state
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end

        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": 4001,
                            "errorDescription": "Payer FSP insufficient liquidity",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
        deactivate POS_HANDLER
    end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.12(Sun Oct 21 05:15:15 CDT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_191-8u191-b12-0ubuntu0.16.04.1-b12
Operating System: Linux
OS Version: 4.4.0-31-generic
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>