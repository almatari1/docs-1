<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4392px" preserveAspectRatio="none" style="width:1693px;height:4392px;" version="1.1" viewBox="0 0 1693 4392" width="1693px" zoomAndPan="magnify"><defs><filter height="300%" id="fubtmwot1u0py" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="259" x="718" y="22.9951">2.3.1. Timeout Handler Consume</text><rect fill="#FFFFE0" height="4347.4219" style="stroke: #A80036; stroke-width: 1.0;" width="1326.5" x="39" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="646.75" y="46.3638">Central Service</text><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="4173.6953" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="128.5" y="125.7266"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="374.5" y="4247.4219"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="674.5" y="3529.0391"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="287.8594" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="785.5" y="615.25"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="785.5" y="963.375"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="1561.625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="785.5" y="1159.3047"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="181.0625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="300.6563"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="122.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1308.5" y="329.7891"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1308.5" y="644.3828"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1308.5" y="992.5078"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1308.5" y="1254.7031"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1308.5" y="1528.5625"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1308.5" y="1832.6875"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1308.5" y="2106.5469"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="349.7891" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1308.5" y="2342.0078"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="4166.6953" style="stroke: #000000; stroke-width: 2.0;" width="1669" x="13" y="132.7266"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="91.5313" style="stroke: #000000; stroke-width: 2.0;" width="708.5" x="33" y="156.8594"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="300.5938" style="stroke: #000000; stroke-width: 2.0;" width="1444" x="23" y="262.3906"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="441" x="33" y="496.7188"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="334.125" style="stroke: #000000; stroke-width: 2.0;" width="1584" x="33" y="576.9844"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="181.9297" style="stroke: #000000; stroke-width: 2.0;" width="1482" x="33" y="925.1094"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="1607.8906" style="stroke: #000000; stroke-width: 2.0;" width="1639" x="33" y="1121.0391"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="1139.5703" style="stroke: #000000; stroke-width: 2.0;" width="930.5" x="731.5" y="1174.3047"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="1549.4922" style="stroke: #000000; stroke-width: 2.0;" width="728.5" x="23" y="2742.9297"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="1439.0938" style="stroke: #000000; stroke-width: 2.0;" width="708.5" x="33" y="2846.3281"/><rect fill="#FFFFFF" height="718.3828" style="stroke: none; stroke-width: 1.0;" width="708.5" x="33" y="3567.0391"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="133" x2="133" y1="115.7266" y2="4316.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="379.5" x2="379.5" y1="115.7266" y2="4316.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="546.5" x2="546.5" y1="115.7266" y2="4316.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="679.5" x2="679.5" y1="115.7266" y2="4316.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="790.5" x2="790.5" y1="115.7266" y2="4316.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1055.5" x2="1055.5" y1="115.7266" y2="4316.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1313.5" x2="1313.5" y1="115.7266" y2="4316.4219"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="175" x="43" y="112.4248">Transfer Timeout Handler</text><ellipse cx="133.5" cy="83.4297" fill="#FEFECE" filter="url(#fubtmwot1u0py)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="129.5,71.4297,135.5,66.4297,133.5,71.4297,135.5,76.4297,129.5,71.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="175" x="43" y="4328.417">Transfer Timeout Handler</text><ellipse cx="133.5" cy="4347.7188" fill="#FEFECE" filter="url(#fubtmwot1u0py)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="129.5,4335.7188,135.5,4330.7188,133.5,4335.7188,135.5,4340.7188,129.5,4335.7188" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fubtmwot1u0py)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="296.5" y="76.4297"/><rect fill="#FEFECE" filter="url(#fubtmwot1u0py)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="292.5" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="299.5" y="100.4248">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#fubtmwot1u0py)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="296.5" y="4315.4219"/><rect fill="#FEFECE" filter="url(#fubtmwot1u0py)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="292.5" y="4319.4219"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="299.5" y="4339.417">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#fubtmwot1u0py)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="480.5" y="76.4297"/><rect fill="#FEFECE" filter="url(#fubtmwot1u0py)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="476.5" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="483.5" y="100.4248">Notification-Topic</text><rect fill="#FEFECE" filter="url(#fubtmwot1u0py)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="480.5" y="4315.4219"/><rect fill="#FEFECE" filter="url(#fubtmwot1u0py)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="476.5" y="4319.4219"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="483.5" y="4339.417">Notification-Topic</text><rect fill="#FEFECE" filter="url(#fubtmwot1u0py)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="631.5" y="76.4297"/><rect fill="#FEFECE" filter="url(#fubtmwot1u0py)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="627.5" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="634.5" y="100.4248">Event-Topic</text><rect fill="#FEFECE" filter="url(#fubtmwot1u0py)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="631.5" y="4315.4219"/><rect fill="#FEFECE" filter="url(#fubtmwot1u0py)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="627.5" y="4319.4219"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="634.5" y="4339.417">Event-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="741.5" y="112.4248">Transfer DAO</text><ellipse cx="790.5" cy="83.4297" fill="#FEFECE" filter="url(#fubtmwot1u0py)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="778.5" x2="802.5" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="741.5" y="4328.417">Transfer DAO</text><ellipse cx="790.5" cy="4347.7188" fill="#FEFECE" filter="url(#fubtmwot1u0py)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="778.5" x2="802.5" y1="4361.7188" y2="4361.7188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="1003.5" y="112.4248">Segment DAO</text><ellipse cx="1055.5" cy="83.4297" fill="#FEFECE" filter="url(#fubtmwot1u0py)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1043.5" x2="1067.5" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="1003.5" y="4328.417">Segment DAO</text><ellipse cx="1055.5" cy="4347.7188" fill="#FEFECE" filter="url(#fubtmwot1u0py)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1043.5" x2="1067.5" y1="4361.7188" y2="4361.7188"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1265.5" y="112.4248">Central Store</text><path d="M1295.5,63.4297 C1295.5,53.4297 1313.5,53.4297 1313.5,53.4297 C1313.5,53.4297 1331.5,53.4297 1331.5,63.4297 L1331.5,89.4297 C1331.5,99.4297 1313.5,99.4297 1313.5,99.4297 C1313.5,99.4297 1295.5,99.4297 1295.5,89.4297 L1295.5,63.4297 " fill="#FEFECE" filter="url(#fubtmwot1u0py)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1295.5,63.4297 C1295.5,73.4297 1313.5,73.4297 1313.5,73.4297 C1313.5,73.4297 1331.5,73.4297 1331.5,63.4297 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1265.5" y="4328.417">Central Store</text><path d="M1295.5,4341.7188 C1295.5,4331.7188 1313.5,4331.7188 1313.5,4331.7188 C1313.5,4331.7188 1331.5,4331.7188 1331.5,4341.7188 L1331.5,4367.7188 C1331.5,4377.7188 1313.5,4377.7188 1313.5,4377.7188 C1313.5,4377.7188 1295.5,4377.7188 1295.5,4367.7188 L1295.5,4341.7188 " fill="#FEFECE" filter="url(#fubtmwot1u0py)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1295.5,4341.7188 C1295.5,4351.7188 1313.5,4351.7188 1313.5,4351.7188 C1313.5,4351.7188 1331.5,4351.7188 1331.5,4341.7188 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="4173.6953" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="128.5" y="125.7266"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="374.5" y="4247.4219"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="674.5" y="3529.0391"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="287.8594" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="785.5" y="615.25"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="785.5" y="963.375"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="1561.625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="785.5" y="1159.3047"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="181.0625" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1050.5" y="300.6563"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="122.7969" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1308.5" y="329.7891"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1308.5" y="644.3828"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="77.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1308.5" y="992.5078"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1308.5" y="1254.7031"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1308.5" y="1528.5625"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1308.5" y="1832.6875"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1308.5" y="2106.5469"/><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="349.7891" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1308.5" y="2342.0078"/><path d="M13,132.7266 L253,132.7266 L253,139.7266 L243,149.7266 L13,149.7266 L13,132.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="4166.6953" style="stroke: #000000; stroke-width: 2.0;" width="1669" x="13" y="132.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="195" x="28" y="145.7935">Timeout Handler Consume</text><path d="M33,156.8594 L265,156.8594 L265,163.8594 L255,173.8594 L33,173.8594 L33,156.8594 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="91.5313" style="stroke: #000000; stroke-width: 2.0;" width="708.5" x="33" y="156.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="187" x="48" y="169.9263">Persist Event Information</text><polygon fill="#A80036" points="667.5,191.125,677.5,195.125,667.5,199.125,671.5,195.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="138.5" x2="673.5" y1="195.125" y2="195.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="145.5" y="190.0591">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="158.5" y="190.0591">Publish event information</text><rect fill="#FFFFFF" filter="url(#fubtmwot1u0py)" height="40.2656" style="stroke: #000000; stroke-width: 2.0;" width="690.5" x="40" y="203.125"/><polygon fill="#EEEEEE" points="40,203.125,106,203.125,106,210.125,96,220.125,40,220.125,40,203.125" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="53" y="217.1919">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="281.75" y="236.1919">Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="36" x="448.75" y="236.1919">9.1.0.</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="448.75" x2="484.75" y1="238.1919" y2="238.1919"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="484.75" y="236.1919">}</text><path d="M23,262.3906 L628,262.3906 L628,269.3906 L618,279.3906 L23,279.3906 L23,262.3906 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="300.5938" style="stroke: #000000; stroke-width: 2.0;" width="1444" x="23" y="262.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="560" x="38" y="275.4575">Get previous checkpoint of last record processed (Lower limit for inclusion)</text><polygon fill="#A80036" points="1038.5,296.6563,1048.5,300.6563,1038.5,304.6563,1042.5,300.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="138.5" x2="1044.5" y1="300.6563" y2="300.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="145.5" y="295.5903">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="158.5" y="295.5903">Get last segment as @intervalMin</text><polygon fill="#A80036" points="1296.5,325.7891,1306.5,329.7891,1296.5,333.7891,1300.5,329.7891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1060.5" x2="1302.5" y1="329.7891" y2="329.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1067.5" y="324.7231">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="1080.5" y="324.7231">Get last segment as @intervalMin</text><polygon fill="#FFFFE0" filter="url(#fubtmwot1u0py)" points="1180,342.7891,1447,342.7891,1457,383.7891,1447,425.7891,1180,425.7891,1170,383.7891,1180,342.7891" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="1182" y="358.856">SELECT value INTO @intervalMin</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1182" y="373.9888">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="65" x="1222" y="373.9888">segment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="1182" y="389.1216">WHERE segmentType = 'timeout'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="1182" y="404.2544">AND enumeration = 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="1182" y="419.3872">AND tableName = 'transferStateChange'</text><polygon fill="#A80036" points="1071.5,448.5859,1061.5,452.5859,1071.5,456.5859,1067.5,452.5859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1065.5" x2="1312.5" y1="452.5859" y2="452.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1077.5" y="447.52">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="1090.5" y="447.52">Return @intervalMin</text><polygon fill="#A80036" points="149.5,477.7188,139.5,481.7188,149.5,485.7188,145.5,481.7188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="143.5" x2="1054.5" y1="481.7188" y2="481.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="155.5" y="476.6528">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="168.5" y="476.6528">Return @intervalMin</text><path d="M33,496.7188 L103,496.7188 L103,503.7188 L93,513.7188 L33,513.7188 L33,496.7188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="441" x="33" y="496.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="25" x="48" y="509.7856">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="351" x="118" y="508.9292">[@intervalMin IS NULL =&gt; segment record NOT FOUND]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="138.5" x2="180.5" y1="534.9844" y2="534.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="180.5" x2="180.5" y1="534.9844" y2="547.9844"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="139.5" x2="180.5" y1="547.9844" y2="547.9844"/><polygon fill="#A80036" points="149.5,543.9844,139.5,547.9844,149.5,551.9844,145.5,547.9844" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="145.5" y="529.9185">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="135" x="158.5" y="529.9185">Set @intervalMin = 0</text><path d="M33,576.9844 L163,576.9844 L163,583.9844 L153,593.9844 L33,593.9844 L33,576.9844 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="334.125" style="stroke: #000000; stroke-width: 2.0;" width="1584" x="33" y="576.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="85" x="48" y="590.0513">Do Cleanup</text><polygon fill="#A80036" points="773.5,611.25,783.5,615.25,773.5,619.25,777.5,615.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="138.5" x2="779.5" y1="615.25" y2="615.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="145.5" y="610.1841">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="158.5" y="610.1841">Clean up transferTimeout from finalised transfers</text><polygon fill="#A80036" points="1296.5,640.3828,1306.5,644.3828,1296.5,648.3828,1300.5,644.3828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="795.5" x2="1302.5" y1="644.3828" y2="644.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="802.5" y="639.3169">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="815.5" y="639.3169">Clean up transferTimeout from finalised transfers</text><polygon fill="#FFFFE0" filter="url(#fubtmwot1u0py)" points="1029,687.3828,1597,687.3828,1607,781.3828,1597,876.3828,1029,876.3828,1019,781.3828,1029,687.3828" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="1031" y="703.4497">DELETE tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1031" y="718.5825">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="1071" y="718.5825">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="1193" y="718.5825">AS tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="564" x="1031" y="733.7153">JOIN (SELECT tsc.transferId, MAX(tsc.transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1055" y="748.8481">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="1095" y="748.8481">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="1217" y="748.8481">tt1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="1055" y="763.981">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="1085" y="763.981">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1243" y="763.981">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="1055" y="779.1138">ON tsc.transferId = tt1.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="1055" y="794.2466">GROUP BY transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="1031" y="809.3794">ON ts.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="1031" y="824.5122">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="1061" y="824.5122">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1219" y="824.5122">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="1031" y="839.645">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="459" x="1031" y="854.7778">WHERE tsc.transferStateId IN ('RECEIVED_FULFIL', 'COMMITTED', 'FAILED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="505" x="1047" y="869.9106">, 'EXPIRED', 'REJECTED', 'EXPIRED_PREPARED', 'EXPIRED_RESERVED', 'ABORTED')</text><polygon fill="#A80036" points="149.5,899.1094,139.5,903.1094,149.5,907.1094,145.5,903.1094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="143.5" x2="789.5" y1="903.1094" y2="903.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="155.5" y="898.0435">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="168.5" y="898.0435">Return success</text><path d="M33,925.1094 L439,925.1094 L439,932.1094 L429,942.1094 L33,942.1094 L33,925.1094 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="181.9297" style="stroke: #000000; stroke-width: 2.0;" width="1482" x="33" y="925.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="361" x="48" y="938.1763">Determine IntervalMax (Upper limit for inclusion)</text><polygon fill="#A80036" points="773.5,959.375,783.5,963.375,773.5,967.375,777.5,963.375" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="138.5" x2="779.5" y1="963.375" y2="963.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="145.5" y="958.3091">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="167.5" y="958.3091">Get last transferStateChangeId as @intervalMax</text><polygon fill="#A80036" points="1296.5,988.5078,1306.5,992.5078,1296.5,996.5078,1300.5,992.5078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="795.5" x2="1302.5" y1="992.5078" y2="992.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="802.5" y="987.4419">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="824.5" y="987.4419">Get last transferStateChangeId as @intervalMax</text><polygon fill="#FFFFE0" filter="url(#fubtmwot1u0py)" points="1132,1005.5078,1495,1005.5078,1505,1024.5078,1495,1043.5078,1132,1043.5078,1122,1024.5078,1132,1005.5078" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="1134" y="1021.5747">SELECT MAX(transferStateChangeId) INTO @intervalMax</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1134" y="1036.7075">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="1174" y="1036.7075">transferStateChange</text><polygon fill="#A80036" points="806.5,1065.9063,796.5,1069.9063,806.5,1073.9063,802.5,1069.9063" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="800.5" x2="1312.5" y1="1069.9063" y2="1069.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="812.5" y="1064.8403">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="834.5" y="1064.8403">Return @intervalMax</text><polygon fill="#A80036" points="149.5,1095.0391,139.5,1099.0391,149.5,1103.0391,145.5,1099.0391" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="143.5" x2="789.5" y1="1099.0391" y2="1099.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="155.5" y="1093.9731">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="177.5" y="1093.9731">Return @intervalMax</text><path d="M33,1121.0391 L420,1121.0391 L420,1128.0391 L410,1138.0391 L33,1138.0391 L33,1121.0391 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1607.8906" style="stroke: #000000; stroke-width: 2.0;" width="1639" x="33" y="1121.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="342" x="48" y="1134.106">Prepare data and return the list for expiration</text><polygon fill="#A80036" points="773.5,1155.3047,783.5,1159.3047,773.5,1163.3047,777.5,1159.3047" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="138.5" x2="779.5" y1="1159.3047" y2="1159.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="145.5" y="1154.2388">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="285" x="167.5" y="1154.2388">Prepare data and get transfers to be expired</text><path d="M731.5,1174.3047 L904.5,1174.3047 L904.5,1181.3047 L894.5,1191.3047 L731.5,1191.3047 L731.5,1174.3047 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1139.5703" style="stroke: #000000; stroke-width: 2.0;" width="930.5" x="731.5" y="1174.3047"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="128" x="746.5" y="1187.3716">DB TRANSACTION</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="795.5" x2="837.5" y1="1212.5703" y2="1212.5703"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="837.5" x2="837.5" y1="1212.5703" y2="1225.5703"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="796.5" x2="837.5" y1="1225.5703" y2="1225.5703"/><polygon fill="#A80036" points="806.5,1221.5703,796.5,1225.5703,806.5,1229.5703,802.5,1225.5703" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="802.5" y="1207.5044">15</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165" x="824.5" y="1207.5044">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="993.5" y="1207.5044">= now()</text><polygon fill="#A80036" points="1296.5,1250.7031,1306.5,1254.7031,1296.5,1258.7031,1300.5,1254.7031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="795.5" x2="1302.5" y1="1254.7031" y2="1254.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="802.5" y="1249.6372">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="294" x="824.5" y="1249.6372">Insert all new transfers still in processing state</text><polygon fill="#FFFFE0" filter="url(#fubtmwot1u0py)" points="1052,1297.7031,1574,1297.7031,1584,1391.7031,1574,1486.7031,1052,1486.7031,1042,1391.7031,1052,1297.7031" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="1054" y="1313.77">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="1137" y="1313.77">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="1255" y="1313.77">(transferId, expirationDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="1054" y="1328.9028">SELECT t.transferId, t.expirationDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1054" y="1344.0356">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="59" x="1094" y="1344.0356">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="1157" y="1344.0356">t</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="518" x="1054" y="1359.1685">JOIN (SELECT transferId, MAX(transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1078" y="1374.3013">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="1118" y="1374.3013">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="295" x="1078" y="1389.4341">WHERE transferStateChangeId &gt; @intervalMin</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="294" x="1078" y="1404.5669">AND transferStateChangeId &lt;= @intervalMax</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="1078" y="1419.6997">GROUP BY transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="1054" y="1434.8325">ON ts.transferId = t.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="1054" y="1449.9653">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="1084" y="1449.9653">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1242" y="1449.9653">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="1054" y="1465.0981">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="414" x="1054" y="1480.231">WHERE tsc.transferStateId IN ('RECEIVED_PREPARE', 'RESERVED')</text><polygon fill="#A80036" points="1296.5,1524.5625,1306.5,1528.5625,1296.5,1532.5625,1300.5,1528.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="795.5" x2="1302.5" y1="1528.5625" y2="1528.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="802.5" y="1515.9302">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="824.5" y="1508.3638">Insert transfer state ABORTED for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="824.5" y="1523.4966">expired RECEIVED_PREPARE transfers</text><polygon fill="#FFFFE0" filter="url(#fubtmwot1u0py)" points="984,1571.5625,1642,1571.5625,1652,1680.5625,1642,1790.5625,984,1790.5625,974,1680.5625,984,1571.5625" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="986" y="1587.6294">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="1069" y="1587.6294">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="654" x="986" y="1602.7622">SELECT tt.transferId, 'EXPIRED_PREPARED' AS transferStateId, 'Aborted by Timeout Handler' AS reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="986" y="1617.895">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="1026" y="1617.895">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1148" y="1617.895">tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="986" y="1633.0278">JOIN (</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="458" x="1025" y="1633.0278">-- Following subquery is reused 3 times and may be optimized if needed</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="545" x="1010" y="1648.1606">SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1010" y="1663.2935">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="1050" y="1663.2935">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="1208" y="1663.2935">tsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="1010" y="1678.4263">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="1040" y="1678.4263">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="1162" y="1678.4263">tt1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="1010" y="1693.5591">ON tt1.transferId = tsc1.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="1010" y="1708.6919">GROUP BY tsc1.transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="986" y="1723.8247">ON ts.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="986" y="1738.9575">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="1016" y="1738.9575">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1174" y="1738.9575">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="986" y="1754.0903">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="336" x="986" y="1769.2231">WHERE tt.expirationDate &lt; {transactionTimestamp}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="304" x="986" y="1784.356">AND tsc.transferStateId = 'RECEIVED_PREPARE'</text><polygon fill="#A80036" points="1296.5,1828.6875,1306.5,1832.6875,1296.5,1836.6875,1300.5,1832.6875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="795.5" x2="1302.5" y1="1832.6875" y2="1832.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="802.5" y="1820.0552">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="824.5" y="1812.4888">Insert transfer state EXPIRED for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="824.5" y="1827.6216">expired RESERVED transfers</text><polygon fill="#FFFFE0" filter="url(#fubtmwot1u0py)" points="984,1875.6875,1642,1875.6875,1652,1977.6875,1642,2079.6875,984,2079.6875,974,1977.6875,984,1875.6875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="986" y="1891.7544">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="1069" y="1891.7544">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="654" x="986" y="1906.8872">SELECT tt.transferId, 'RESERVED_TIMEOUT' AS transferStateId, 'Expired by Timeout Handler' AS reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="986" y="1922.02">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="1026" y="1922.02">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1148" y="1922.02">tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="580" x="986" y="1937.1528">JOIN (SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1010" y="1952.2856">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="1050" y="1952.2856">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="1208" y="1952.2856">tsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="1010" y="1967.4185">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="1040" y="1967.4185">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="1162" y="1967.4185">tt1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="1010" y="1982.5513">ON tt1.transferId = tsc1.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="1010" y="1997.6841">GROUP BY tsc1.transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="986" y="2012.8169">ON ts.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="986" y="2027.9497">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="1016" y="2027.9497">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1174" y="2027.9497">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="986" y="2043.0825">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="336" x="986" y="2058.2153">WHERE tt.expirationDate &lt; {transactionTimestamp}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="245" x="986" y="2073.3481">AND tsc.transferStateId = 'RESERVED'</text><polygon fill="#A80036" points="1296.5,2102.5469,1306.5,2106.5469,1296.5,2110.5469,1300.5,2106.5469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="795.5" x2="1302.5" y1="2106.5469" y2="2106.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="802.5" y="2101.481">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="824.5" y="2101.481">Update segment table to be used for the next run</text><polygon fill="#FFFFE0" filter="url(#fubtmwot1u0py)" points="1100,2149.5469,1527,2149.5469,1537,2228.5469,1527,2308.5469,1100,2308.5469,1090,2228.5469,1100,2149.5469" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="1102" y="2165.6138">IF @intervalMin = 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="45" x="1118" y="2180.7466">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="1118" y="2195.8794">INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="65" x="1152" y="2195.8794">segment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="1217" y="2195.8794">(segmentType, enumeration, tableName, value)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="1118" y="2211.0122">VALUES ('timeout', 0, 'transferStateChange', @intervalMax)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="1102" y="2226.145">ELSE</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="1118" y="2241.2778">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="65" x="1174" y="2241.2778">segment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="1118" y="2256.4106">SET value = @intervalMax</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="1118" y="2271.5435">WHERE segmentType = 'timeout'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="1118" y="2286.6763">AND enumeration = 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="1118" y="2301.8091">AND tableName = 'transferStateChange'</text><polygon fill="#A80036" points="1296.5,2338.0078,1306.5,2342.0078,1296.5,2346.0078,1300.5,2342.0078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="795.5" x2="1302.5" y1="2342.0078" y2="2342.0078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="802.5" y="2336.9419">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="326" x="824.5" y="2336.9419">Get list of transfers to be expired with current state</text><polygon fill="#FFFFE0" filter="url(#fubtmwot1u0py)" points="1021,2355.0078,1605,2355.0078,1615,2510.0078,1605,2665.0078,1021,2665.0078,1011,2510.0078,1021,2355.0078" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="492" x="1023" y="2371.0747">SELECT tt.*, tsc.transferStateId, tp1.participantCurrencyId payerParticipantId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="1055" y="2386.2075">tp2.participantCurrencyId payeeParticipantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1023" y="2401.3403">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="1063" y="2401.3403">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="10" x="1185" y="2401.3403">tt</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="580" x="1023" y="2416.4731">JOIN (SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1055" y="2431.606">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="1095" y="2431.606">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="27" x="1253" y="2431.606">tsc1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="1055" y="2446.7388">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="1085" y="2446.7388">transferTimeout</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="18" x="1207" y="2446.7388">tt1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="1055" y="2461.8716">ON tt1.transferId = tsc1.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="1055" y="2477.0044">GROUP BY tsc1.transferId) ts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="1023" y="2492.1372">ON ts.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="1023" y="2507.27">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="154" x="1053" y="2507.27">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="19" x="1211" y="2507.27">tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="1023" y="2522.4028">ON tsc.transferStateChangeId = ts.maxTransferStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="1023" y="2537.5356">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140" x="1053" y="2537.5356">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1197" y="2537.5356">tp1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="1023" y="2552.6685">ON tp1.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="360" x="1023" y="2567.8013">AND tp1.transferParticipantRoleTypeId = {PAYER_DFSP}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="321" x="1023" y="2582.9341">AND tp1.ledgerEntryTypeId = {PRINCIPLE_VALUE}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="1023" y="2598.0669">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140" x="1053" y="2598.0669">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1197" y="2598.0669">tp2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="1023" y="2613.1997">ON tp2.transferId = tt.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="360" x="1023" y="2628.3325">AND tp2.transferParticipantRoleTypeId = {PAYEE_DFSP}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="321" x="1023" y="2643.4653">AND tp2.ledgerEntryTypeId = {PRINCIPLE_VALUE}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="336" x="1023" y="2658.5981">WHERE tt.expirationDate &lt; {transactionTimestamp}</text><polygon fill="#A80036" points="806.5,2687.7969,796.5,2691.7969,806.5,2695.7969,802.5,2691.7969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="800.5" x2="1312.5" y1="2691.7969" y2="2691.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="812.5" y="2686.731">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="834.5" y="2686.731">Return list</text><polygon fill="#A80036" points="149.5,2716.9297,139.5,2720.9297,149.5,2724.9297,145.5,2720.9297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="143.5" x2="789.5" y1="2720.9297" y2="2720.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="155.5" y="2715.8638">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="64" x="177.5" y="2715.8638">Return list</text><path d="M23,2742.9297 L100,2742.9297 L100,2749.9297 L90,2759.9297 L23,2759.9297 L23,2742.9297 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1549.4922" style="stroke: #000000; stroke-width: 2.0;" width="728.5" x="23" y="2742.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="38" y="2755.9966">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="183" x="115" y="2755.1401">[for each transfer in the list]</text><path d="M143,2790.0625 L143,2830.0625 L602,2830.0625 L602,2800.0625 L592,2790.0625 L143,2790.0625 " fill="#D3D3D3" filter="url(#fubtmwot1u0py)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M592,2790.0625 L592,2800.0625 L602,2800.0625 L592,2790.0625 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="41" x="149" y="2807.1294">TODO</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="190" y="2807.1294">:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="198" y="2807.1294">Red</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="226" y="2807.1294">in the bellow messages is to be discussed with the DA</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="438" x="149" y="2822.2622">during review because at this point the referred data is not available.</text><path d="M33,2846.3281 L97,2846.3281 L97,2853.3281 L87,2863.3281 L33,2863.3281 L33,2846.3281 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1439.0938" style="stroke: #000000; stroke-width: 2.0;" width="708.5" x="33" y="2846.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="48" y="2859.395">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="263" x="112" y="2858.5386">[transferStateId == 'RECEIVED_PREPARE']</text><path d="M143,2868.4609 L143,3498.4609 L551,3498.4609 L551,2878.4609 L541,2868.4609 L143,2868.4609 " fill="#FFFF00" filter="url(#fubtmwot1u0py)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M541,2868.4609 L541,2878.4609 L551,2878.4609 L541,2868.4609 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="149" y="2885.5278">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="149" y="2900.6606">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="165" y="2915.7935">id: &lt;transferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="165" y="2930.9263">from: &lt;payerParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="165" y="2946.0591">to: &lt;payeeParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="165" y="2961.1919">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="165" y="2976.3247">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="181" y="2991.4575"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="181" y="2991.4575">headers:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="241" y="2991.4575">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="197" y="3006.5903">Content-Length: &lt;Content-Length&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="197" y="3021.7231">Content-Type: &lt;Content-Type&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="197" y="3036.856">Date: &lt;Date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="197" y="3051.9888">X-Forwarded-For: &lt;X-Forwarded-For&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="197" y="3067.1216">FSPIOP-Source: &lt;FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="197" y="3082.2544">FSPIOP-Destination: &lt;FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="197" y="3097.3872">FSPIOP-Encryption: &lt;FSPIOP-Encryption&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="197" y="3112.52">FSPIOP-Signature: &lt;FSPIOP-Signature&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="197" y="3127.6528">FSPIOP-URI: &lt;FSPIOP-URI&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="197" y="3142.7856">FSPIOP-HTTP-Method: &lt;FSPIOP-HTTP-Method&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="181" y="3157.9185">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="181" y="3173.0513">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="201" y="3188.1841">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="217" y="3203.3169">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="217" y="3218.4497">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="217" y="3233.5825">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="201" y="3248.7153">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="181" y="3263.8481">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="165" y="3278.981">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="165" y="3294.1138">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="181" y="3309.2466">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="197" y="3324.3794">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="197" y="3339.5122">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="197" y="3354.645">action: timeout-received,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="197" y="3369.7778">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="197" y="3384.9106">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="213" y="3400.0435">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="213" y="3415.1763">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="213" y="3430.3091">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="197" y="3445.4419">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="181" y="3460.5747">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="165" y="3475.7075">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="149" y="3490.8403">}</text><polygon fill="#A80036" points="662.5,3525.0391,672.5,3529.0391,662.5,3533.0391,666.5,3529.0391" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="138.5" x2="668.5" y1="3529.0391" y2="3529.0391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="145.5" y="3523.9731">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="167.5" y="3523.9731">Publish Notification event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="33" x2="741.5" y1="3568.0391" y2="3568.0391"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="204" x="38" y="3578.2495">[transferStateId == 'RESERVED']</text><path d="M143,3586.8438 L143,4216.8438 L547,4216.8438 L547,3596.8438 L537,3586.8438 L143,3586.8438 " fill="#FFFF00" filter="url(#fubtmwot1u0py)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M537,3586.8438 L537,3596.8438 L547,3596.8438 L537,3586.8438 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="149" y="3603.9106">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="149" y="3619.0435">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="165" y="3634.1763">id: &lt;transferId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="165" y="3649.3091">from: &lt;payerParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="165" x="165" y="3664.4419">to: &lt;payeeParticipantId&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="165" y="3679.5747">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="165" y="3694.7075">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="181" y="3709.8403"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="181" y="3709.8403">headers:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="241" y="3709.8403">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="197" y="3724.9731">Content-Length: &lt;Content-Length&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="197" y="3740.106">Content-Type: &lt;Content-Type&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="197" y="3755.2388">Date: &lt;Date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="197" y="3770.3716">X-Forwarded-For: &lt;X-Forwarded-For&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="224" x="197" y="3785.5044">FSPIOP-Source: &lt;FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="197" y="3800.6372">FSPIOP-Destination: &lt;FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="197" y="3815.77">FSPIOP-Encryption: &lt;FSPIOP-Encryption&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="197" y="3830.9028">FSPIOP-Signature: &lt;FSPIOP-Signature&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="197" y="3846.0356">FSPIOP-URI: &lt;FSPIOP-URI&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="197" y="3861.1685">FSPIOP-HTTP-Method: &lt;FSPIOP-HTTP-Method&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="181" y="3876.3013">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="181" y="3891.4341">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="197" y="3906.5669">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="213" y="3921.6997">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="238" x="213" y="3936.8325">"errorDescription": "Transfer expired",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="213" y="3951.9653">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="197" y="3967.0981">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="181" y="3982.231">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="165" y="3997.3638">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="165" y="4012.4966">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="181" y="4027.6294">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="197" y="4042.7622">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="197" y="4057.895">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="197" y="4073.0278">action: timeout-reserved,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="197" y="4088.1606">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="197" y="4103.2935">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="213" y="4118.4263">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="213" y="4133.5591">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="213" y="4148.6919">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="197" y="4163.8247">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="181" y="4178.9575">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="165" y="4194.0903">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="149" y="4209.2231">}</text><polygon fill="#A80036" points="362.5,4243.4219,372.5,4247.4219,362.5,4251.4219,366.5,4247.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="138.5" x2="368.5" y1="4247.4219" y2="4247.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="145.5" y="4242.356">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="167.5" y="4242.356">Route &amp; Publish Position event</text><!--
@startuml
title 2.3.1. Timeout Handler Consume 

autonumber


control "Transfer Timeout Handler" as TIMEOUT_HANDLER
collections "topic-transfer-position" as TOPIC_TRANSFER_POSITION
collections "Notification-Topic" as NOTIFICATIONS_TOPIC
collections "Event-Topic" as EVENT_TOPIC
entity "Segment DAO" as SEGMENT_DAO
entity "Transfer DAO" as TRANSFER_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TIMEOUT_HANDLER
    participant TOPIC_TRANSFER_POSITION
    participant NOTIFICATIONS_TOPIC
    participant EVENT_TOPIC
    participant TRANSFER_DAO
    participant SEGMENT_DAO
    participant DB
end box


group Timeout Handler Consume
    activate TIMEOUT_HANDLER
    group Persist Event Information
        TIMEOUT_HANDLER -> EVENT_TOPIC: Publish event information
        ref over TIMEOUT_HANDLER, EVENT_TOPIC :  Event Handler Consume {[[https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg 9.1.0.]]}
    end

    group Get previous checkpoint of last record processed (Lower limit for inclusion)
        TIMEOUT_HANDLER -> SEGMENT_DAO: Get last segment as @intervalMin
        activate SEGMENT_DAO
        SEGMENT_DAO -> DB: Get last segment as @intervalMin
        hnote over DB #lightyellow
            SELECT value INTO @intervalMin
            FROM **segment**
            WHERE segmentType = 'timeout'
            AND enumeration = 0
            AND tableName = 'transferStateChange'
        end note
        activate DB
        DB - -> SEGMENT_DAO: Return @intervalMin
        deactivate DB
        SEGMENT_DAO - -> TIMEOUT_HANDLER: Return @intervalMin
        deactivate SEGMENT_DAO
        opt @intervalMin IS NULL => segment record NOT FOUND
            TIMEOUT_HANDLER->TIMEOUT_HANDLER: Set @intervalMin = 0
        end
    end

    group Do Cleanup
        TIMEOUT_HANDLER -> TRANSFER_DAO: Clean up transferTimeout from finalised transfers
        activate TRANSFER_DAO
        TRANSFER_DAO -> DB: Clean up transferTimeout from finalised transfers
        hnote over DB #lightyellow
            DELETE tt
            FROM **transferTimeout** AS tt
            JOIN (SELECT tsc.transferId, MAX(tsc.transferStateChangeId) maxTransferStateChangeId
                  FROM **transferTimeout** tt1
                  JOIN **transferStateChange** tsc
                  ON tsc.transferId = tt1.transferId
                  GROUP BY transferId) ts
            ON ts.transferId = tt.transferId
            JOIN **transferStateChange** tsc
            ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
            WHERE tsc.transferStateId IN ('RECEIVED_FULFIL', 'COMMITTED', 'FAILED'
                , 'EXPIRED', 'REJECTED', 'EXPIRED_PREPARED', 'EXPIRED_RESERVED', 'ABORTED')
        end note
        activate DB
        deactivate DB
        TRANSFER_DAO - -> TIMEOUT_HANDLER: Return success
        deactivate TRANSFER_DAO
    end

    group Determine IntervalMax (Upper limit for inclusion)
        TIMEOUT_HANDLER -> TRANSFER_DAO: Get last transferStateChangeId as @intervalMax
        activate TRANSFER_DAO
        TRANSFER_DAO -> DB: Get last transferStateChangeId as @intervalMax
        hnote over DB #lightyellow
            SELECT MAX(transferStateChangeId) INTO @intervalMax
            FROM **transferStateChange**
        end note
        activate DB
        DB - -> TRANSFER_DAO: Return @intervalMax
        deactivate DB
        TRANSFER_DAO - -> TIMEOUT_HANDLER: Return @intervalMax
        deactivate TRANSFER_DAO
    end

    
    group Prepare data and return the list for expiration
        TIMEOUT_HANDLER -> TRANSFER_DAO: Prepare data and get transfers to be expired
        activate TRANSFER_DAO
        group <color #blue>DB TRANSACTION</color>
            TRANSFER_DAO <-> TRANSFER_DAO: **transactionTimestamp** = now()
            TRANSFER_DAO -> DB: Insert all new transfers still in processing state
            hnote over DB #lightyellow
                INSERT INTO **transferTimeout**(transferId, expirationDate)
                SELECT t.transferId, t.expirationDate
                FROM **transfer** t
                JOIN (SELECT transferId, MAX(transferStateChangeId) maxTransferStateChangeId
                      FROM **transferStateChange**
                      WHERE transferStateChangeId > @intervalMin
                      AND transferStateChangeId <= @intervalMax
                      GROUP BY transferId) ts
                ON ts.transferId = t.transferId
                JOIN **transferStateChange** tsc
                ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
                WHERE tsc.transferStateId IN ('RECEIVED_PREPARE', 'RESERVED')
            end note
            activate DB
            deactivate DB

            TRANSFER_DAO -> DB: Insert transfer state ABORTED for\nexpired RECEIVED_PREPARE transfers
            hnote over DB #lightyellow
                INSERT INTO **transferStateChange**
                SELECT tt.transferId, 'EXPIRED_PREPARED' AS transferStateId, 'Aborted by Timeout Handler' AS reason
                FROM **transferTimeout** tt
                JOIN ( <color #FF0000>- - Following subquery is reused 3 times and may be optimized if needed</color>
                      SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId
                      FROM **transferStateChange** tsc1
                      JOIN **transferTimeout** tt1
                      ON tt1.transferId = tsc1.transferId
                      GROUP BY tsc1.transferId) ts
                ON ts.transferId = tt.transferId
                JOIN **transferStateChange** tsc
                ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
                WHERE tt.expirationDate < {transactionTimestamp}
                AND tsc.transferStateId = 'RECEIVED_PREPARE'
            end note
            activate DB
            deactivate DB

            TRANSFER_DAO -> DB: Insert transfer state EXPIRED for\nexpired RESERVED transfers
            hnote over DB #lightyellow
                INSERT INTO **transferStateChange**
                SELECT tt.transferId, 'RESERVED_TIMEOUT' AS transferStateId, 'Expired by Timeout Handler' AS reason
                FROM **transferTimeout** tt
                JOIN (SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId
                      FROM **transferStateChange** tsc1
                      JOIN **transferTimeout** tt1
                      ON tt1.transferId = tsc1.transferId
                      GROUP BY tsc1.transferId) ts
                ON ts.transferId = tt.transferId
                JOIN **transferStateChange** tsc
                ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
                WHERE tt.expirationDate < {transactionTimestamp}
                AND tsc.transferStateId = 'RESERVED'
            end note
            activate DB
            deactivate DB

            TRANSFER_DAO -> DB: Update segment table to be used for the next run
            hnote over DB #lightyellow
                IF @intervalMin = 0
                    INSERT
                    INTO **segment**(segmentType, enumeration, tableName, value)
                    VALUES ('timeout', 0, 'transferStateChange', @intervalMax)
                ELSE
                    UPDATE **segment**
                    SET value = @intervalMax
                    WHERE segmentType = 'timeout'
                    AND enumeration = 0
                    AND tableName = 'transferStateChange'
            end note
            activate DB
            deactivate DB
        end

        TRANSFER_DAO -> DB: Get list of transfers to be expired with current state
        hnote over DB #lightyellow
            SELECT tt.*, tsc.transferStateId, tp1.participantCurrencyId payerParticipantId, 
                    tp2.participantCurrencyId payeeParticipantId
            FROM **transferTimeout** tt
            JOIN (SELECT tsc1.transferId, MAX(tsc1.transferStateChangeId) maxTransferStateChangeId
                    FROM **transferStateChange** tsc1
                    JOIN **transferTimeout** tt1
                    ON tt1.transferId = tsc1.transferId
                    GROUP BY tsc1.transferId) ts
            ON ts.transferId = tt.transferId
            JOIN **transferStateChange** tsc
            ON tsc.transferStateChangeId = ts.maxTransferStateChangeId
            JOIN **transferParticipant** tp1
            ON tp1.transferId = tt.transferId
            AND tp1.transferParticipantRoleTypeId = {PAYER_DFSP}
            AND tp1.ledgerEntryTypeId = {PRINCIPLE_VALUE}
            JOIN **transferParticipant** tp2
            ON tp2.transferId = tt.transferId
            AND tp2.transferParticipantRoleTypeId = {PAYEE_DFSP}
            AND tp2.ledgerEntryTypeId = {PRINCIPLE_VALUE}
            WHERE tt.expirationDate < {transactionTimestamp}
        end note
        activate DB
        TRANSFER_DAO <- - DB: Return list
        deactivate DB
        TRANSFER_DAO - -> TIMEOUT_HANDLER: Return list
        deactivate TRANSFER_DAO
    end

    loop for each transfer in the list
        |||
        note right of TIMEOUT_HANDLER #lightgray
            **TODO**: <color #FF0000>Red</color> in the bellow messages is to be discussed with the DA 
            during review because at this point the referred data is not available.
        end note

        alt transferStateId == 'RECEIVED_PREPARE'
            note right of TIMEOUT_HANDLER #yellow
                Message:
                {
                    id: <transferId>,
                    from: <payerParticipantId>,
                    to: <payeeParticipantId>,
                    type: application/json,
                    content: {
                        <color #FF0000>headers:</color> {
                            Content-Length: <Content-Length>,
                            Content-Type: <Content-Type>,
                            Date: <Date>,
                            X-Forwarded-For: <X-Forwarded-For>,
                            FSPIOP-Source: <FSPIOP-Source>,
                            FSPIOP-Destination: <FSPIOP-Destination>,
                            FSPIOP-Encryption: <FSPIOP-Encryption>,
                            FSPIOP-Signature: <FSPIOP-Signature>,
                            FSPIOP-URI: <FSPIOP-URI>,
                            FSPIOP-HTTP-Method: <FSPIOP-HTTP-Method>
                        },
                        payload: {
                             "errorInformation": {
                                 "errorCode": 3303,
                                 "errorDescription": "Transfer expired",
                                 "extensionList": <transferMessage.extensionList>
                             }
                        }
                    },
                    metadata: {
                        event: {
                            id: <uuid>,
                            type: notification,
                            action: timeout-received,
                            createdAt: <timestamp>,
                            state: {
                                status: 'error',
                                code: <errorInformation.errorCode>
                                description: <errorInformation.errorDescription>
                            }
                        }
                    }
                }
            end note
            TIMEOUT_HANDLER -> EVENT_TOPIC: Publish Notification event
            activate EVENT_TOPIC
            deactivate EVENT_TOPIC
        else transferStateId == 'RESERVED'
            note right of TIMEOUT_HANDLER #yellow
                Message:
                {
                    id: <transferId>,
                    from: <payerParticipantId>,
                    to: <payeeParticipantId>,
                    type: application/json,
                    content: {
                        <color #FF0000>headers:</color> {
                            Content-Length: <Content-Length>,
                            Content-Type: <Content-Type>,
                            Date: <Date>,
                            X-Forwarded-For: <X-Forwarded-For>,
                            FSPIOP-Source: <FSPIOP-Source>,
                            FSPIOP-Destination: <FSPIOP-Destination>,
                            FSPIOP-Encryption: <FSPIOP-Encryption>,
                            FSPIOP-Signature: <FSPIOP-Signature>,
                            FSPIOP-URI: <FSPIOP-URI>,
                            FSPIOP-HTTP-Method: <FSPIOP-HTTP-Method>
                        },
                        payload: {
                            "errorInformation": {
                                "errorCode": 3303,
                                "errorDescription": "Transfer expired",
                                "extensionList": <transferMessage.extensionList>
                            }
                        }
                    },
                    metadata: {
                        event: {
                            id: <uuid>,
                            type: position,
                            action: timeout-reserved,
                            createdAt: <timestamp>,
                            state: {
                                status: 'error',
                                code: <errorInformation.errorCode>
                                description: <errorInformation.errorDescription>
                            }
                        }
                    }
                }
            end note
            TIMEOUT_HANDLER -> TOPIC_TRANSFER_POSITION: Route & Publish Position event
            activate TOPIC_TRANSFER_POSITION
            deactivate TOPIC_TRANSFER_POSITION
        end

    end

    deactivate TIMEOUT_HANDLER
end
@enduml

PlantUML version 1.2018.12(Sun Oct 21 05:15:15 CDT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_191-8u191-b12-0ubuntu0.16.04.1-b12
Operating System: Linux
OS Version: 4.4.0-31-generic
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>