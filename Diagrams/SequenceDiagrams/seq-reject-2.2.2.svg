<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1749px" preserveAspectRatio="none" style="width:1543px;height:1749px;" version="1.1" viewBox="0 0 1543 1749" width="1543px" zoomAndPan="magnify"><defs><filter height="300%" id="f17wu68eqsw632" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="324" x="610.5" y="22.9951">2.2.2. Position Handler Consume (Reject)</text><rect fill="#FFFFE0" height="1704.1016" style="stroke: #A80036; stroke-width: 1.0;" width="1446" x="29" y="34.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="696.5" y="46.3638">Central Service</text><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="115" y="195.125"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="1537.375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="468" y="125.7266"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="983" y="1557.1641"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1103" y="488.3203"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1103" y="1012.4453"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1210" y="830.7813"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1418" y="517.4531"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1418" y="859.9141"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1418" y="1041.5781"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="1523.375" style="stroke: #000000; stroke-width: 2.0;" width="1519" x="13" y="132.7266"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="1492.2422" style="stroke: #000000; stroke-width: 2.0;" width="1499" x="23" y="156.8594"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="90.3984" style="stroke: #000000; stroke-width: 2.0;" width="542.5" x="372.5" y="240.125"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="522.5" x="382.5" y="264.2578"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="91.5313" style="stroke: #000000; stroke-width: 2.0;" width="356.5" x="207" y="344.5234"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="181.9297" style="stroke: #000000; stroke-width: 2.0;" width="1104.5" x="382.5" y="450.0547"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="132.5313" style="stroke: #000000; stroke-width: 2.0;" width="625.5" x="372.5" y="645.9844"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="101.3984" style="stroke: #000000; stroke-width: 2.0;" width="605.5" x="382.5" y="670.1172"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="167.6641" style="stroke: #000000; stroke-width: 2.0;" width="1112.5" x="382.5" y="792.5156"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="167.6641" style="stroke: #000000; stroke-width: 2.0;" width="1129.5" x="382.5" y="974.1797"/><rect fill="#FFFFFF" height="53.9375" style="stroke: none; stroke-width: 1.0;" width="1499" x="23" y="1595.1641"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="120" x2="120" y1="115.7266" y2="1673.1016"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="269" x2="269" y1="115.7266" y2="1673.1016"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="472.5" x2="472.5" y1="115.7266" y2="1673.1016"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="988" x2="988" y1="115.7266" y2="1673.1016"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1108" x2="1108" y1="115.7266" y2="1673.1016"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1215" x2="1215" y1="115.7266" y2="1673.1016"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1423" x2="1423" y1="115.7266" y2="1673.1016"/><rect fill="#FEFECE" filter="url(#f17wu68eqsw632)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="37" y="76.4297"/><rect fill="#FEFECE" filter="url(#f17wu68eqsw632)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="33" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="40" y="100.4248">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#f17wu68eqsw632)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="37" y="1672.1016"/><rect fill="#FEFECE" filter="url(#f17wu68eqsw632)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="33" y="1676.1016"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="40" y="1696.0967">topic-transfer-position</text><rect fill="#FEFECE" filter="url(#f17wu68eqsw632)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="221" y="76.4297"/><rect fill="#FEFECE" filter="url(#f17wu68eqsw632)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="217" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="224" y="100.4248">Event-Topic</text><rect fill="#FEFECE" filter="url(#f17wu68eqsw632)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="221" y="1672.1016"/><rect fill="#FEFECE" filter="url(#f17wu68eqsw632)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="96" x="217" y="1676.1016"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="82" x="224" y="1696.0967">Event-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="155" x="392.5" y="112.4248">Position Event Handler</text><ellipse cx="473" cy="83.4297" fill="#FEFECE" filter="url(#f17wu68eqsw632)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="469,71.4297,475,66.4297,473,71.4297,475,76.4297,469,71.4297" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="155" x="392.5" y="1685.0967">Position Event Handler</text><ellipse cx="473" cy="1704.3984" fill="#FEFECE" filter="url(#f17wu68eqsw632)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="469,1692.3984,475,1687.3984,473,1692.3984,475,1697.3984,469,1692.3984" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#f17wu68eqsw632)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="931" y="76.4297"/><rect fill="#FEFECE" filter="url(#f17wu68eqsw632)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="927" y="80.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="934" y="100.4248">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f17wu68eqsw632)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="931" y="1672.1016"/><rect fill="#FEFECE" filter="url(#f17wu68eqsw632)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="114" x="927" y="1676.1016"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="100" x="934" y="1696.0967">Transfer-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="1059" y="112.4248">Transfer DAO</text><ellipse cx="1108" cy="83.4297" fill="#FEFECE" filter="url(#f17wu68eqsw632)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1096" x2="1120" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="92" x="1059" y="1685.0967">Transfer DAO</text><ellipse cx="1108" cy="1704.3984" fill="#FEFECE" filter="url(#f17wu68eqsw632)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1096" x2="1120" y1="1718.3984" y2="1718.3984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1167" y="112.4248">Position DAO</text><ellipse cx="1215" cy="83.4297" fill="#FEFECE" filter="url(#f17wu68eqsw632)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1203" x2="1227" y1="97.4297" y2="97.4297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1167" y="1685.0967">Position DAO</text><ellipse cx="1215" cy="1704.3984" fill="#FEFECE" filter="url(#f17wu68eqsw632)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1203" x2="1227" y1="1718.3984" y2="1718.3984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1375" y="112.4248">Central Store</text><path d="M1405,63.4297 C1405,53.4297 1423,53.4297 1423,53.4297 C1423,53.4297 1441,53.4297 1441,63.4297 L1441,89.4297 C1441,99.4297 1423,99.4297 1423,99.4297 C1423,99.4297 1405,99.4297 1405,89.4297 L1405,63.4297 " fill="#FEFECE" filter="url(#f17wu68eqsw632)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1405,63.4297 C1405,73.4297 1423,73.4297 1423,73.4297 C1423,73.4297 1441,73.4297 1441,63.4297 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1375" y="1685.0967">Central Store</text><path d="M1405,1698.3984 C1405,1688.3984 1423,1688.3984 1423,1688.3984 C1423,1688.3984 1441,1688.3984 1441,1698.3984 L1441,1724.3984 C1441,1734.3984 1423,1734.3984 1423,1734.3984 C1423,1734.3984 1405,1734.3984 1405,1724.3984 L1405,1698.3984 " fill="#FEFECE" filter="url(#f17wu68eqsw632)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1405,1698.3984 C1405,1708.3984 1423,1708.3984 1423,1708.3984 C1423,1708.3984 1441,1708.3984 1441,1698.3984 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="115" y="195.125"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="1537.375" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="468" y="125.7266"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="983" y="1557.1641"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="135.6641" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1103" y="488.3203"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1103" y="1012.4453"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="121.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1210" y="830.7813"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1418" y="517.4531"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1418" y="859.9141"/><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1418" y="1041.5781"/><path d="M13,132.7266 L316,132.7266 L316,139.7266 L306,149.7266 L13,149.7266 L13,132.7266 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1523.375" style="stroke: #000000; stroke-width: 2.0;" width="1519" x="13" y="132.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="258" x="28" y="145.7935">Position Handler Consume (Reject)</text><path d="M23,156.8594 L87,156.8594 L87,163.8594 L77,173.8594 L23,173.8594 L23,156.8594 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1492.2422" style="stroke: #000000; stroke-width: 2.0;" width="1499" x="23" y="156.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="38" y="169.9263">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="174" x="102" y="169.0698">[Consume Single Message]</text><polygon fill="#A80036" points="136,191.125,126,195.125,136,199.125,132,195.125" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="130" x2="467" y1="195.125" y2="195.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="142" y="190.0591">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="279" x="155" y="190.0591">Consume Position event message for Payer</text><path d="M372.5,240.125 L460.5,240.125 L460.5,247.125 L450.5,257.125 L372.5,257.125 L372.5,240.125 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="90.3984" style="stroke: #000000; stroke-width: 2.0;" width="542.5" x="372.5" y="240.125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="387.5" y="253.1919">break</text><path d="M382.5,264.2578 L534.5,264.2578 L534.5,271.2578 L524.5,281.2578 L382.5,281.2578 L382.5,264.2578 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.2656" style="stroke: #000000; stroke-width: 2.0;" width="522.5" x="382.5" y="264.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="107" x="397.5" y="277.3247">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="478" x2="520" y1="302.5234" y2="302.5234"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="520" x2="520" y1="302.5234" y2="315.5234"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="479" x2="520" y1="315.5234" y2="315.5234"/><polygon fill="#A80036" points="489,311.5234,479,315.5234,489,319.5234,485,315.5234" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="485" y="297.4575">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="395" x="498" y="297.4575">Validate event - Rule: type == 'position' &amp;&amp; action == 'reject'</text><path d="M207,344.5234 L439,344.5234 L439,351.5234 L429,361.5234 L207,361.5234 L207,344.5234 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="91.5313" style="stroke: #000000; stroke-width: 2.0;" width="356.5" x="207" y="344.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="187" x="222" y="357.5903">Persist Event Information</text><polygon fill="#A80036" points="280,378.7891,270,382.7891,280,386.7891,276,382.7891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="274" x2="467" y1="382.7891" y2="382.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="286" y="377.7231">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="299" y="377.7231">Publish event information</text><rect fill="#FFFFFF" filter="url(#f17wu68eqsw632)" height="40.2656" style="stroke: #000000; stroke-width: 2.0;" width="338.5" x="214" y="390.7891"/><polygon fill="#EEEEEE" points="214,390.7891,280,390.7891,280,397.7891,270,407.7891,214,407.7891,214,390.7891" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="21" x="227" y="404.856">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="279.75" y="423.856">Event Handler Consume {</text><a target="_top" xlink:actuate="onRequest" xlink:href="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:show="new" xlink:title="https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="36" x="446.75" y="423.856">9.1.0.</text><line style="stroke: #0000FF; stroke-width: 1.0;" x1="446.75" x2="482.75" y1="425.856" y2="425.856"/></a><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="482.75" y="423.856">}</text><path d="M382.5,450.0547 L670.5,450.0547 L670.5,457.0547 L660.5,467.0547 L382.5,467.0547 L382.5,450.0547 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="181.9297" style="stroke: #000000; stroke-width: 2.0;" width="1104.5" x="382.5" y="450.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="243" x="397.5" y="463.1216">Retrieve Current Transfer Details</text><polygon fill="#A80036" points="1091,484.3203,1101,488.3203,1091,492.3203,1095,488.3203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="478" x2="1097" y1="488.3203" y2="488.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="485" y="483.2544">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="335" x="498" y="483.2544">Request to retrieve expirationDate &amp; transferStateId</text><polygon fill="#A80036" points="1406,513.4531,1416,517.4531,1406,521.4531,1410,517.4531" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1113" x2="1412" y1="517.4531" y2="517.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1120" y="512.3872">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="1133" y="512.3872">Fetch from database</text><polygon fill="#A80036" points="1124,542.5859,1114,546.5859,1124,550.5859,1120,546.5859" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1118" x2="1422" y1="546.5859" y2="546.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1130" y="541.52">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1147" y="541.52"/><polygon fill="#FFFFE0" filter="url(#f17wu68eqsw632)" points="1378,559.5859,1467,559.5859,1477,578.5859,1467,597.5859,1378,597.5859,1368,578.5859,1378,559.5859" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1380" y="575.6528">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="85" x="1380" y="590.7856">transferState</text><polygon fill="#A80036" points="489,619.9844,479,623.9844,489,627.9844,485,623.9844" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="483" x2="1107" y1="623.9844" y2="623.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="495" y="618.9185">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="398" x="508" y="618.9185">Return transfer.expirationDate &amp; transferState.transferStateId</text><path d="M372.5,645.9844 L460.5,645.9844 L460.5,652.9844 L450.5,662.9844 L372.5,662.9844 L372.5,645.9844 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="132.5313" style="stroke: #000000; stroke-width: 2.0;" width="625.5" x="372.5" y="645.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43" x="387.5" y="659.0513">break</text><path d="M382.5,670.1172 L554.5,670.1172 L554.5,677.1172 L544.5,687.1172 L382.5,687.1172 L382.5,670.1172 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="101.3984" style="stroke: #000000; stroke-width: 2.0;" width="605.5" x="382.5" y="670.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="397.5" y="683.1841">Validate Transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="478" x2="520" y1="708.3828" y2="708.3828"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="520" x2="520" y1="708.3828" y2="721.3828"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="479" x2="520" y1="721.3828" y2="721.3828"/><polygon fill="#A80036" points="489,717.3828,479,721.3828,489,725.3828,485,721.3828" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="485" y="703.3169">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="498" y="703.3169">Validate transfer expiration - Rule: Date.now() &lt; expirationDate</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="478" x2="520" y1="750.5156" y2="750.5156"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="520" x2="520" y1="750.5156" y2="763.5156"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="479" x2="520" y1="763.5156" y2="763.5156"/><polygon fill="#A80036" points="489,759.5156,479,763.5156,489,767.5156,485,763.5156" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="485" y="745.4497">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="498" y="745.4497">Validate transfer state - Rule:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="689" y="745.4497">transferState</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="189" x="787" y="745.4497">Id corresponds to 'RESERVED'</text><path d="M382.5,792.5156 L684.5,792.5156 L684.5,799.5156 L674.5,809.5156 L382.5,809.5156 L382.5,792.5156 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="167.6641" style="stroke: #000000; stroke-width: 2.0;" width="1112.5" x="382.5" y="792.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="257" x="397.5" y="805.5825">Decrement Payer Position (DFSP1)</text><polygon fill="#A80036" points="1198,826.7813,1208,830.7813,1198,834.7813,1202,830.7813" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="478" x2="1204" y1="830.7813" y2="830.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="485" y="825.7153">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="298" x="507" y="825.7153">Request to decrement latest position for Payer</text><polygon fill="#A80036" points="1406,855.9141,1416,859.9141,1406,863.9141,1410,859.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1220" x2="1412" y1="859.9141" y2="859.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1227" y="854.8481">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="1249" y="854.8481">Persist decrement to DB</text><polygon fill="#FFFFE0" filter="url(#f17wu68eqsw632)" points="1371,902.9141,1475,902.9141,1485,913.9141,1475,925.9141,1371,925.9141,1361,913.9141,1371,902.9141" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="100" x="1373" y="918.981">transferPosition</text><polygon fill="#A80036" points="489,948.1797,479,952.1797,489,956.1797,485,952.1797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="483" x2="1214" y1="952.1797" y2="952.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="495" y="947.1138">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="517" y="947.1138">Return success</text><path d="M382.5,974.1797 L827.5,974.1797 L827.5,981.1797 L817.5,991.1797 L382.5,991.1797 L382.5,974.1797 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="167.6641" style="stroke: #000000; stroke-width: 2.0;" width="1129.5" x="382.5" y="974.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="400" x="397.5" y="987.2466">Persist Transfer State (with transferState='ABORTED')</text><polygon fill="#A80036" points="1091,1008.4453,1101,1012.4453,1091,1016.4453,1095,1012.4453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="478" x2="1097" y1="1012.4453" y2="1012.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="485" y="1007.3794">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="507" y="1007.3794">Request to persist transfer state</text><polygon fill="#A80036" points="1406,1037.5781,1416,1041.5781,1406,1045.5781,1410,1041.5781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1113" x2="1412" y1="1041.5781" y2="1041.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1120" y="1036.5122">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1142" y="1036.5122">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#f17wu68eqsw632)" points="1354,1084.5781,1492,1084.5781,1502,1095.5781,1492,1107.5781,1354,1107.5781,1344,1095.5781,1354,1084.5781" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="1356" y="1100.645">transferStateChange</text><polygon fill="#A80036" points="489,1129.8438,479,1133.8438,489,1137.8438,485,1133.8438" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="483" x2="1107" y1="1133.8438" y2="1133.8438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="495" y="1128.7778">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="517" y="1128.7778">Return success</text><path d="M483,1153.8438 L483,1526.8438 L798,1526.8438 L798,1163.8438 L788,1153.8438 L483,1153.8438 " fill="#FFFF00" filter="url(#f17wu68eqsw632)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M788,1153.8438 L788,1163.8438 L798,1163.8438 L788,1153.8438 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="489" y="1170.9106">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="489" y="1186.0435">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="505" y="1201.1763">id: &lt;ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="267" x="505" y="1216.3091">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="505" y="1231.4419">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="505" y="1246.5747">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="505" y="1261.7075">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="521" y="1276.8403">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="521" y="1291.9731">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="505" y="1307.106">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="505" y="1322.2388">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="521" y="1337.3716">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="537" y="1352.5044">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="537" y="1367.6372">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="537" y="1382.77">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="537" y="1397.9028">action: reject,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="537" y="1413.0356">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="537" y="1428.1685">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="553" y="1443.3013">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="47" x="553" y="1458.4341">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="537" y="1473.5669">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="521" y="1488.6997">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="505" y="1503.8325">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="489" y="1518.9653">}</text><polygon fill="#A80036" points="971,1553.1641,981,1557.1641,971,1561.1641,975,1557.1641" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="478" x2="977" y1="1557.1641" y2="1557.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="485" y="1552.0981">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="507" y="1552.0981">Publish Transfer event</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1522" y1="1596.1641" y2="1596.1641"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="28" y="1606.3745">[Consume Batch Messages]</text><path d="M244,1614.9688 L244,1639.9688 L459,1639.9688 L459,1624.9688 L449,1614.9688 L244,1614.9688 " fill="#ADD8E6" filter="url(#f17wu68eqsw632)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M449,1614.9688 L449,1624.9688 L459,1624.9688 L449,1614.9688 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="250" y="1632.0356">To be delivered by future story</text><!--
@startuml
title 2.2.2. Position Handler Consume (Reject)

autonumber


collections "topic-transfer-position" as TOPIC_TRANSFER_POSITION
control "Position Event Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
collections "Event-Topic" as TOPIC_EVENT
entity "Transfer DAO" as TRANS_DAO
entity "Position DAO" as POS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_TRANSFER_POSITION
    participant TOPIC_EVENT
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TRANS_DAO
    participant POS_DAO
    participant DB
end box

activate POS_HANDLER
group Position Handler Consume (Reject)
    alt Consume Single Message
        TOPIC_TRANSFER_POSITION <- POS_HANDLER: Consume Position event message for Payer
        activate TOPIC_TRANSFER_POSITION
        deactivate TOPIC_TRANSFER_POSITION

        break
            group Validate Event
                POS_HANDLER <-> POS_HANDLER: Validate event - Rule: type == 'position' && action == 'reject'
            end
        end

        group Persist Event Information
            POS_HANDLER -> TOPIC_EVENT: Publish event information
	        ref over POS_HANDLER, TOPIC_EVENT :  Event Handler Consume {[[https://github.com/mojaloop/docs/blob/develop/CentralServices/seq_diagrams/seq-event-9.1.0.svg 9.1.0.]]} 
        end

        group Retrieve Current Transfer Details
            POS_HANDLER -> TRANS_DAO: Request to retrieve expirationDate & transferStateId
            activate TRANS_DAO
            TRANS_DAO -> DB: Fetch from database
            activate DB
            DB - -> TRANS_DAO
            deactivate DB
            hnote over DB #lightyellow
                transfer
                transferState
            end note
            POS_HANDLER <- - TRANS_DAO: Return transfer.expirationDate & transferState.transferStateId
            deactivate TRANS_DAO
        end

        break
            group Validate Transfer
                POS_HANDLER <-> POS_HANDLER: Validate transfer expiration - Rule: Date.now() < expirationDate
                POS_HANDLER <-> POS_HANDLER: Validate transfer state - Rule: **transferState**Id corresponds to 'RESERVED'
            end
        end

        group Decrement Payer Position (DFSP1)
            POS_HANDLER -> POS_DAO: Request to decrement latest position for Payer
            activate POS_DAO
            POS_DAO -> DB: Persist decrement to DB
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                transferPosition
            end note
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end

        group Persist Transfer State (with transferState='ABORTED')
            POS_HANDLER -> TRANS_DAO: Request to persist transfer state
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist transfer state
            activate DB
            deactivate DB
            hnote over DB #lightyellow
                transferStateChange
            end note
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end
    
        note right of POS_HANDLER #yellow
            Message:
            {
                id: <ID>,
                from: <transferHeaders.FSPIOP-Source>,
                to: <transferHeaders.FSPIOP-Destination>,
                type: application/json,
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: reject,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event
        activate TOPIC_TRANSFERS
        deactivate TOPIC_TRANSFERS

    else Consume Batch Messages
        note left of POS_HANDLER #lightblue
            To be delivered by future story
        end note
    end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.12(Sun Oct 21 05:15:15 CDT 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_191-8u191-b12-0ubuntu0.16.04.1-b12
Operating System: Linux
OS Version: 4.4.0-31-generic
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>